"use strict";
/**
 * Event Utilities
 * Helper functions and utilities for working with events
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.createEventId = createEventId;
exports.createCorrelationId = createCorrelationId;
exports.createDomainEvent = createDomainEvent;
exports.createIntegrationEvent = createIntegrationEvent;
exports.createEventEnvelope = createEventEnvelope;
exports.isValidEvent = isValidEvent;
exports.isDomainEvent = isDomainEvent;
exports.isIntegrationEvent = isIntegrationEvent;
exports.filterEventsByType = filterEventsByType;
exports.filterEventsByAggregateId = filterEventsByAggregateId;
exports.filterEventsByTimeRange = filterEventsByTimeRange;
exports.serializeEvent = serializeEvent;
exports.deserializeEvent = deserializeEvent;
exports.sortEventsByTimestamp = sortEventsByTimestamp;
exports.groupEventsByAggregateId = groupEventsByAggregateId;
exports.getLatestEventByAggregateId = getLatestEventByAggregateId;
exports.addEventMetadata = addEventMetadata;
exports.getEventMetadata = getEventMetadata;
exports.correlateEvents = correlateEvents;
exports.createEventChain = createEventChain;
// Event creation utilities
function createEventId() {
    return `evt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
function createCorrelationId() {
    return `corr_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
function createDomainEvent(type, aggregateId, aggregateType, aggregateVersion, data, options) {
    return {
        id: createEventId(),
        type,
        version: '1.0',
        source: options?.source || 'madmall-platform',
        timestamp: new Date().toISOString(),
        correlationId: options?.correlationId,
        causationId: options?.causationId,
        metadata: options?.metadata,
        aggregateId,
        aggregateType,
        aggregateVersion,
        data,
    };
}
function createIntegrationEvent(type, data, options) {
    return {
        id: createEventId(),
        type,
        version: '1.0',
        source: options?.source || 'madmall-platform',
        timestamp: new Date().toISOString(),
        correlationId: options?.correlationId,
        causationId: options?.causationId,
        metadata: options?.metadata,
        data,
    };
}
// Event envelope utilities
function createEventEnvelope(event, options) {
    return {
        event,
        headers: options?.headers || {},
        messageId: createEventId(),
        timestamp: new Date().toISOString(),
        retryCount: 0,
        maxRetries: options?.maxRetries || 3,
        delayUntil: options?.delayUntil?.toISOString(),
    };
}
// Event validation utilities
function isValidEvent(event) {
    return (event &&
        typeof event.id === 'string' &&
        typeof event.type === 'string' &&
        typeof event.version === 'string' &&
        typeof event.source === 'string' &&
        typeof event.timestamp === 'string');
}
function isDomainEvent(event) {
    return ('aggregateId' in event &&
        'aggregateType' in event &&
        'aggregateVersion' in event &&
        'data' in event);
}
function isIntegrationEvent(event) {
    return 'data' in event && !isDomainEvent(event);
}
// Event filtering utilities
function filterEventsByType(events, eventType) {
    return events.filter((event) => event.type === eventType);
}
function filterEventsByAggregateId(events, aggregateId) {
    return events.filter(event => event.aggregateId === aggregateId);
}
function filterEventsByTimeRange(events, startTime, endTime) {
    return events.filter(event => {
        const eventTime = new Date(event.timestamp);
        return eventTime >= startTime && eventTime <= endTime;
    });
}
// Event serialization utilities
function serializeEvent(event) {
    return JSON.stringify(event, null, 0);
}
function deserializeEvent(eventJson) {
    const event = JSON.parse(eventJson);
    if (!isValidEvent(event)) {
        throw new Error('Invalid event format');
    }
    return event;
}
// Event stream utilities
function sortEventsByTimestamp(events) {
    return [...events].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
}
function groupEventsByAggregateId(events) {
    const grouped = new Map();
    for (const event of events) {
        const existing = grouped.get(event.aggregateId) || [];
        existing.push(event);
        grouped.set(event.aggregateId, existing);
    }
    return grouped;
}
function getLatestEventByAggregateId(events, aggregateId) {
    const aggregateEvents = events
        .filter(event => event.aggregateId === aggregateId)
        .sort((a, b) => b.aggregateVersion - a.aggregateVersion);
    return aggregateEvents[0];
}
// Event metadata utilities
function addEventMetadata(event, metadata) {
    return {
        ...event,
        metadata: {
            ...event.metadata,
            ...metadata,
        },
    };
}
function getEventMetadata(event, key) {
    return event.metadata?.[key];
}
// Event correlation utilities
function correlateEvents(events, correlationId) {
    return events.filter(event => event.correlationId === correlationId);
}
function createEventChain(events) {
    const chain = [];
    const eventMap = new Map();
    // Index events by ID
    for (const event of events) {
        eventMap.set(event.id, event);
    }
    // Find root events (no causation ID)
    const rootEvents = events.filter(event => !event.causationId);
    // Build chains from root events
    for (const rootEvent of rootEvents) {
        buildChainFromEvent(rootEvent, eventMap, chain);
    }
    return chain;
}
function buildChainFromEvent(event, eventMap, chain) {
    chain.push(event);
    // Find events caused by this event
    const causedEvents = Array.from(eventMap.values())
        .filter(e => e.causationId === event.id);
    for (const causedEvent of causedEvents) {
        buildChainFromEvent(causedEvent, eventMap, chain);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJldmVudC11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQUtILHNDQUVDO0FBRUQsa0RBRUM7QUFFRCw4Q0EyQkM7QUFFRCx3REFxQkM7QUFHRCxrREFpQkM7QUFHRCxvQ0FTQztBQUVELHNDQU9DO0FBRUQsZ0RBRUM7QUFHRCxnREFLQztBQUVELDhEQUtDO0FBRUQsMERBU0M7QUFHRCx3Q0FFQztBQUVELDRDQU1DO0FBR0Qsc0RBSUM7QUFFRCw0REFVQztBQUVELGtFQVNDO0FBR0QsNENBV0M7QUFFRCw0Q0FFQztBQUdELDBDQUVDO0FBRUQsNENBa0JDO0FBeE5ELDJCQUEyQjtBQUMzQixTQUFnQixhQUFhO0lBQzNCLE9BQU8sT0FBTyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDeEUsQ0FBQztBQUVELFNBQWdCLG1CQUFtQjtJQUNqQyxPQUFPLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO0FBQ3pFLENBQUM7QUFFRCxTQUFnQixpQkFBaUIsQ0FDL0IsSUFBWSxFQUNaLFdBQW1CLEVBQ25CLGFBQXFCLEVBQ3JCLGdCQUF3QixFQUN4QixJQUFPLEVBQ1AsT0FLQztJQUVELE9BQU87UUFDTCxFQUFFLEVBQUUsYUFBYSxFQUFFO1FBQ25CLElBQUk7UUFDSixPQUFPLEVBQUUsS0FBSztRQUNkLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxJQUFJLGtCQUFrQjtRQUM3QyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUs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TUFBTSxFQUFFLENBQUM7UUFDM0IsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxxQ0FBcUM7SUFDckMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRTlELGdDQUFnQztJQUNoQyxLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ25DLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQzFCLEtBQWdCLEVBQ2hCLFFBQWdDLEVBQ2hDLEtBQWtCO0lBRWxCLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFbEIsbUNBQW1DO0lBQ25DLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQy9DLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEtBQUssS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRTNDLEtBQUssTUFBTSxXQUFXLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdkMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwRCxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRXZlbnQgVXRpbGl0aWVzXG4gKiBIZWxwZXIgZnVuY3Rpb25zIGFuZCB1dGlsaXRpZXMgZm9yIHdvcmtpbmcgd2l0aCBldmVudHNcbiAqL1xuXG5pbXBvcnQgeyBCYXNlRXZlbnQsIERvbWFpbkV2ZW50LCBJbnRlZ3JhdGlvbkV2ZW50LCBFdmVudEVudmVsb3BlLCBFdmVudE1ldGFkYXRhIH0gZnJvbSAnLi9iYXNlJztcblxuLy8gRXZlbnQgY3JlYXRpb24gdXRpbGl0aWVzXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRXZlbnRJZCgpOiBzdHJpbmcge1xuICByZXR1cm4gYGV2dF8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDb3JyZWxhdGlvbklkKCk6IHN0cmluZyB7XG4gIHJldHVybiBgY29ycl8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVEb21haW5FdmVudDxUPihcbiAgdHlwZTogc3RyaW5nLFxuICBhZ2dyZWdhdGVJZDogc3RyaW5nLFxuICBhZ2dyZWdhdGVUeXBlOiBzdHJpbmcsXG4gIGFnZ3JlZ2F0ZVZlcnNpb246IG51bWJlcixcbiAgZGF0YTogVCxcbiAgb3B0aW9ucz86IHtcbiAgICBzb3VyY2U/OiBzdHJpbmc7XG4gICAgY29ycmVsYXRpb25JZD86IHN0cmluZztcbiAgICBjYXVzYXRpb25JZD86IHN0cmluZztcbiAgICBtZXRhZGF0YT86IGFueTtcbiAgfVxuKTogRG9tYWluRXZlbnQ8VD4ge1xuICByZXR1cm4ge1xuICAgIGlkOiBjcmVhdGVFdmVudElkKCksXG4gICAgdHlwZSxcbiAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICBzb3VyY2U6IG9wdGlvbnM/LnNvdXJjZSB8fCAnbWFkbWFsbC1wbGF0Zm9ybScsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgY29ycmVsYXRpb25JZDogb3B0aW9ucz8uY29ycmVsYXRpb25JZCxcbiAgICBjYXVzYXRpb25JZDogb3B0aW9ucz8uY2F1c2F0aW9uSWQsXG4gICAgbWV0YWRhdGE6IG9wdGlvbnM/Lm1ldGFkYXRhLFxuICAgIGFnZ3JlZ2F0ZUlkLFxuICAgIGFnZ3JlZ2F0ZVR5cGUsXG4gICAgYWdncmVnYXRlVmVyc2lvbixcbiAgICBkYXRhLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlSW50ZWdyYXRpb25FdmVudDxUPihcbiAgdHlwZTogc3RyaW5nLFxuICBkYXRhOiBULFxuICBvcHRpb25zPzoge1xuICAgIHNvdXJjZT86IHN0cmluZztcbiAgICBjb3JyZWxhdGlvbklkPzogc3RyaW5nO1xuICAgIGNhdXNhdGlvbklkPzogc3RyaW5nO1xuICAgIG1ldGFkYXRhPzogYW55O1xuICB9XG4pOiBJbnRlZ3JhdGlvbkV2ZW50PFQ+IHtcbiAgcmV0dXJuIHtcbiAgICBpZDogY3JlYXRlRXZlbnRJZCgpLFxuICAgIHR5cGUsXG4gICAgdmVyc2lvbjogJzEuMCcsXG4gICAgc291cmNlOiBvcHRpb25zPy5zb3VyY2UgfHwgJ21hZG1hbGwtcGxhdGZvcm0nLFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIGNvcnJlbGF0aW9uSWQ6IG9wdGlvbnM/LmNvcnJlbGF0aW9uSWQsXG4gICAgY2F1c2F0aW9uSWQ6IG9wdGlvbnM/LmNhdXNhdGlvbklkLFxuICAgIG1ldGFkYXRhOiBvcHRpb25zPy5tZXRhZGF0YSxcbiAgICBkYXRhLFxuICB9O1xufVxuXG4vLyBFdmVudCBlbnZlbG9wZSB1dGlsaXRpZXNcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFdmVudEVudmVsb3BlPFQgZXh0ZW5kcyBCYXNlRXZlbnQ+KFxuICBldmVudDogVCxcbiAgb3B0aW9ucz86IHtcbiAgICBoZWFkZXJzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICBtYXhSZXRyaWVzPzogbnVtYmVyO1xuICAgIGRlbGF5VW50aWw/OiBEYXRlO1xuICB9XG4pOiBFdmVudEVudmVsb3BlPFQ+IHtcbiAgcmV0dXJuIHtcbiAgICBldmVudCxcbiAgICBoZWFkZXJzOiBvcHRpb25zPy5oZWFkZXJzIHx8IHt9LFxuICAgIG1lc3NhZ2VJZDogY3JlYXRlRXZlbnRJZCgpLFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIHJldHJ5Q291bnQ6IDAsXG4gICAgbWF4UmV0cmllczogb3B0aW9ucz8ubWF4UmV0cmllcyB8fCAzLFxuICAgIGRlbGF5VW50aWw6IG9wdGlvbnM/LmRlbGF5VW50aWw/LnRvSVNPU3RyaW5nKCksXG4gIH07XG59XG5cbi8vIEV2ZW50IHZhbGlkYXRpb24gdXRpbGl0aWVzXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZEV2ZW50KGV2ZW50OiBhbnkpOiBldmVudCBpcyBCYXNlRXZlbnQge1xuICByZXR1cm4gKFxuICAgIGV2ZW50ICYmXG4gICAgdHlwZW9mIGV2ZW50LmlkID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBldmVudC50eXBlID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBldmVudC52ZXJzaW9uID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBldmVudC5zb3VyY2UgPT09ICdzdHJpbmcnICYmXG4gICAgdHlwZW9mIGV2ZW50LnRpbWVzdGFtcCA9PT0gJ3N0cmluZydcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRG9tYWluRXZlbnQoZXZlbnQ6IEJhc2VFdmVudCk6IGV2ZW50IGlzIERvbWFpbkV2ZW50IHtcbiAgcmV0dXJuIChcbiAgICAnYWdncmVnYXRlSWQnIGluIGV2ZW50ICYmXG4gICAgJ2FnZ3JlZ2F0ZVR5cGUnIGluIGV2ZW50ICYmXG4gICAgJ2FnZ3JlZ2F0ZVZlcnNpb24nIGluIGV2ZW50ICYmXG4gICAgJ2RhdGEnIGluIGV2ZW50XG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ludGVncmF0aW9uRXZlbnQoZXZlbnQ6IEJhc2VFdmVudCk6IGV2ZW50IGlzIEludGVncmF0aW9uRXZlbnQge1xuICByZXR1cm4gJ2RhdGEnIGluIGV2ZW50ICYmICFpc0RvbWFpbkV2ZW50KGV2ZW50KTtcbn1cblxuLy8gRXZlbnQgZmlsdGVyaW5nIHV0aWxpdGllc1xuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlckV2ZW50c0J5VHlwZTxUIGV4dGVuZHMgQmFzZUV2ZW50PihcbiAgZXZlbnRzOiBCYXNlRXZlbnRbXSxcbiAgZXZlbnRUeXBlOiBzdHJpbmdcbik6IFRbXSB7XG4gIHJldHVybiBldmVudHMuZmlsdGVyKChldmVudCk6IGV2ZW50IGlzIFQgPT4gZXZlbnQudHlwZSA9PT0gZXZlbnRUeXBlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlckV2ZW50c0J5QWdncmVnYXRlSWQoXG4gIGV2ZW50czogRG9tYWluRXZlbnRbXSxcbiAgYWdncmVnYXRlSWQ6IHN0cmluZ1xuKTogRG9tYWluRXZlbnRbXSB7XG4gIHJldHVybiBldmVudHMuZmlsdGVyKGV2ZW50ID0+IGV2ZW50LmFnZ3JlZ2F0ZUlkID09PSBhZ2dyZWdhdGVJZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJFdmVudHNCeVRpbWVSYW5nZShcbiAgZXZlbnRzOiBCYXNlRXZlbnRbXSxcbiAgc3RhcnRUaW1lOiBEYXRlLFxuICBlbmRUaW1lOiBEYXRlXG4pOiBCYXNlRXZlbnRbXSB7XG4gIHJldHVybiBldmVudHMuZmlsdGVyKGV2ZW50ID0+IHtcbiAgICBjb25zdCBldmVudFRpbWUgPSBuZXcgRGF0ZShldmVudC50aW1lc3RhbXApO1xuICAgIHJldHVybiBldmVudFRpbWUgPj0gc3RhcnRUaW1lICYmIGV2ZW50VGltZSA8PSBlbmRUaW1lO1xuICB9KTtcbn1cblxuLy8gRXZlbnQgc2VyaWFsaXphdGlvbiB1dGlsaXRpZXNcbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVFdmVudChldmVudDogQmFzZUV2ZW50KTogc3RyaW5nIHtcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAwKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplRXZlbnQoZXZlbnRKc29uOiBzdHJpbmcpOiBCYXNlRXZlbnQge1xuICBjb25zdCBldmVudCA9IEpTT04ucGFyc2UoZXZlbnRKc29uKTtcbiAgaWYgKCFpc1ZhbGlkRXZlbnQoZXZlbnQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGV2ZW50IGZvcm1hdCcpO1xuICB9XG4gIHJldHVybiBldmVudDtcbn1cblxuLy8gRXZlbnQgc3RyZWFtIHV0aWxpdGllc1xuZXhwb3J0IGZ1bmN0aW9uIHNvcnRFdmVudHNCeVRpbWVzdGFtcChldmVudHM6IEJhc2VFdmVudFtdKTogQmFzZUV2ZW50W10ge1xuICByZXR1cm4gWy4uLmV2ZW50c10uc29ydCgoYSwgYikgPT4gXG4gICAgbmV3IERhdGUoYS50aW1lc3RhbXApLmdldFRpbWUoKSAtIG5ldyBEYXRlKGIudGltZXN0YW1wKS5nZXRUaW1lKClcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwRXZlbnRzQnlBZ2dyZWdhdGVJZChldmVudHM6IERvbWFpbkV2ZW50W10pOiBNYXA8c3RyaW5nLCBEb21haW5FdmVudFtdPiB7XG4gIGNvbnN0IGdyb3VwZWQgPSBuZXcgTWFwPHN0cmluZywgRG9tYWluRXZlbnRbXT4oKTtcbiAgXG4gIGZvciAoY29uc3QgZXZlbnQgb2YgZXZlbnRzKSB7XG4gICAgY29uc3QgZXhpc3RpbmcgPSBncm91cGVkLmdldChldmVudC5hZ2dyZWdhdGVJZCkgfHwgW107XG4gICAgZXhpc3RpbmcucHVzaChldmVudCk7XG4gICAgZ3JvdXBlZC5zZXQoZXZlbnQuYWdncmVnYXRlSWQsIGV4aXN0aW5nKTtcbiAgfVxuICBcbiAgcmV0dXJuIGdyb3VwZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRMYXRlc3RFdmVudEJ5QWdncmVnYXRlSWQoXG4gIGV2ZW50czogRG9tYWluRXZlbnRbXSxcbiAgYWdncmVnYXRlSWQ6IHN0cmluZ1xuKTogRG9tYWluRXZlbnQgfCB1bmRlZmluZWQge1xuICBjb25zdCBhZ2dyZWdhdGVFdmVudHMgPSBldmVudHNcbiAgICAuZmlsdGVyKGV2ZW50ID0+IGV2ZW50LmFnZ3JlZ2F0ZUlkID09PSBhZ2dyZWdhdGVJZClcbiAgICAuc29ydCgoYSwgYikgPT4gYi5hZ2dyZWdhdGVWZXJzaW9uIC0gYS5hZ2dyZWdhdGVWZXJzaW9uKTtcbiAgXG4gIHJldHVybiBhZ2dyZWdhdGVFdmVudHNbMF07XG59XG5cbi8vIEV2ZW50IG1ldGFkYXRhIHV0aWxpdGllc1xuZXhwb3J0IGZ1bmN0aW9uIGFkZEV2ZW50TWV0YWRhdGEoXG4gIGV2ZW50OiBCYXNlRXZlbnQsXG4gIG1ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4pOiBCYXNlRXZlbnQge1xuICByZXR1cm4ge1xuICAgIC4uLmV2ZW50LFxuICAgIG1ldGFkYXRhOiB7XG4gICAgICAuLi5ldmVudC5tZXRhZGF0YSxcbiAgICAgIC4uLm1ldGFkYXRhLFxuICAgIH0sXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFdmVudE1ldGFkYXRhKGV2ZW50OiBCYXNlRXZlbnQsIGtleToga2V5b2YgRXZlbnRNZXRhZGF0YSk6IGFueSB7XG4gIHJldHVybiBldmVudC5tZXRhZGF0YT8uW2tleV07XG59XG5cbi8vIEV2ZW50IGNvcnJlbGF0aW9uIHV0aWxpdGllc1xuZXhwb3J0IGZ1bmN0aW9uIGNvcnJlbGF0ZUV2ZW50cyhldmVudHM6IEJhc2VFdmVudFtdLCBjb3JyZWxhdGlvbklkOiBzdHJpbmcpOiBCYXNlRXZlbnRbXSB7XG4gIHJldHVybiBldmVudHMuZmlsdGVyKGV2ZW50ID0+IGV2ZW50LmNvcnJlbGF0aW9uSWQgPT09IGNvcnJlbGF0aW9uSWQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRXZlbnRDaGFpbihldmVudHM6IEJhc2VFdmVudFtdKTogQmFzZUV2ZW50W10ge1xuICBjb25zdCBjaGFpbjogQmFzZUV2ZW50W10gPSBbXTtcbiAgY29uc3QgZXZlbnRNYXAgPSBuZXcgTWFwPHN0cmluZywgQmFzZUV2ZW50PigpO1xuICBcbiAgLy8gSW5kZXggZXZlbnRzIGJ5IElEXG4gIGZvciAoY29uc3QgZXZlbnQgb2YgZXZlbnRzKSB7XG4gICAgZXZlbnRNYXAuc2V0KGV2ZW50LmlkLCBldmVudCk7XG4gIH1cbiAgXG4gIC8vIEZpbmQgcm9vdCBldmVudHMgKG5vIGNhdXNhdGlvbiBJRClcbiAgY29uc3Qgcm9vdEV2ZW50cyA9IGV2ZW50cy5maWx0ZXIoZXZlbnQgPT4gIWV2ZW50LmNhdXNhdGlvbklkKTtcbiAgXG4gIC8vIEJ1aWxkIGNoYWlucyBmcm9tIHJvb3QgZXZlbnRzXG4gIGZvciAoY29uc3Qgcm9vdEV2ZW50IG9mIHJvb3RFdmVudHMpIHtcbiAgICBidWlsZENoYWluRnJvbUV2ZW50KHJvb3RFdmVudCwgZXZlbnRNYXAsIGNoYWluKTtcbiAgfVxuICBcbiAgcmV0dXJuIGNoYWluO1xufVxuXG5mdW5jdGlvbiBidWlsZENoYWluRnJvbUV2ZW50KFxuICBldmVudDogQmFzZUV2ZW50LFxuICBldmVudE1hcDogTWFwPHN0cmluZywgQmFzZUV2ZW50PixcbiAgY2hhaW46IEJhc2VFdmVudFtdXG4pOiB2b2lkIHtcbiAgY2hhaW4ucHVzaChldmVudCk7XG4gIFxuICAvLyBGaW5kIGV2ZW50cyBjYXVzZWQgYnkgdGhpcyBldmVudFxuICBjb25zdCBjYXVzZWRFdmVudHMgPSBBcnJheS5mcm9tKGV2ZW50TWFwLnZhbHVlcygpKVxuICAgIC5maWx0ZXIoZSA9PiBlLmNhdXNhdGlvbklkID09PSBldmVudC5pZCk7XG4gIFxuICBmb3IgKGNvbnN0IGNhdXNlZEV2ZW50IG9mIGNhdXNlZEV2ZW50cykge1xuICAgIGJ1aWxkQ2hhaW5Gcm9tRXZlbnQoY2F1c2VkRXZlbnQsIGV2ZW50TWFwLCBjaGFpbik7XG4gIH1cbn0iXX0=