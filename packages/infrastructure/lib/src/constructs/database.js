"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatabaseConstruct = void 0;
const constructs_1 = require("constructs");
const aws_dynamodb_1 = require("aws-cdk-lib/aws-dynamodb");
const aws_kms_1 = require("aws-cdk-lib/aws-kms");
const aws_cdk_lib_1 = require("aws-cdk-lib");
class DatabaseConstruct extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { environment, enablePointInTimeRecovery = true, enableStreams = true, removalPolicy = environment === 'prod' ? aws_cdk_lib_1.RemovalPolicy.RETAIN : aws_cdk_lib_1.RemovalPolicy.DESTROY, } = props;
        // Create KMS key for DynamoDB encryption
        this.kmsKey = new aws_kms_1.Key(this, 'DatabaseKmsKey', {
            description: `KMS key for MADMall ${environment} DynamoDB encryption`,
            keyUsage: aws_kms_1.KeyUsage.ENCRYPT_DECRYPT,
            keySpec: aws_kms_1.KeySpec.SYMMETRIC_DEFAULT,
            enableKeyRotation: true,
            removalPolicy,
        });
        aws_cdk_lib_1.Tags.of(this.kmsKey).add('Name', `madmall-${environment}-dynamodb-key`);
        aws_cdk_lib_1.Tags.of(this.kmsKey).add('Environment', environment);
        // Create the main DynamoDB table with single-table design
        this.mainTable = new aws_dynamodb_1.Table(this, 'MainTable', {
            tableName: `madmall-${environment}-main`,
            partitionKey: {
                name: 'PK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            sortKey: {
                name: 'SK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            billingMode: aws_dynamodb_1.BillingMode.PAY_PER_REQUEST,
            encryption: aws_dynamodb_1.TableEncryption.CUSTOMER_MANAGED,
            encryptionKey: this.kmsKey,
            pointInTimeRecovery: enablePointInTimeRecovery,
            stream: enableStreams ? aws_dynamodb_1.StreamViewType.NEW_AND_OLD_IMAGES : undefined,
            removalPolicy,
            deletionProtection: environment === 'prod',
        });
        // Add Global Secondary Indexes (GSIs)
        this.addGlobalSecondaryIndexes();
        // Add tags
        aws_cdk_lib_1.Tags.of(this.mainTable).add('Name', `madmall-${environment}-main-table`);
        aws_cdk_lib_1.Tags.of(this.mainTable).add('Environment', environment);
        aws_cdk_lib_1.Tags.of(this.mainTable).add('Purpose', 'Single-table design for MADMall platform');
    }
    addGlobalSecondaryIndexes() {
        // GSI1: For alternate access patterns (e.g., email lookups, type-based queries)
        this.mainTable.addGlobalSecondaryIndex({
            indexName: 'GSI1',
            partitionKey: {
                name: 'GSI1PK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            sortKey: {
                name: 'GSI1SK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            projectionType: aws_dynamodb_1.ProjectionType.ALL,
        });
        // GSI2: For time-based queries and sorting
        this.mainTable.addGlobalSecondaryIndex({
            indexName: 'GSI2',
            partitionKey: {
                name: 'GSI2PK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            sortKey: {
                name: 'GSI2SK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            projectionType: aws_dynamodb_1.ProjectionType.ALL,
        });
        // GSI3: For status-based queries and filtering
        this.mainTable.addGlobalSecondaryIndex({
            indexName: 'GSI3',
            partitionKey: {
                name: 'GSI3PK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            sortKey: {
                name: 'GSI3SK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            projectionType: aws_dynamodb_1.ProjectionType.KEYS_ONLY,
        });
        // GSI4: For tenant-based queries (multi-tenancy support)
        this.mainTable.addGlobalSecondaryIndex({
            indexName: 'GSI4',
            partitionKey: {
                name: 'GSI4PK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            sortKey: {
                name: 'GSI4SK',
                type: aws_dynamodb_1.AttributeType.STRING,
            },
            projectionType: aws_dynamodb_1.ProjectionType.INCLUDE,
            nonKeyAttributes: ['entityType', 'status', 'createdAt', 'updatedAt'],
        });
    }
    /**
     * Get access patterns documentation for the single-table design
     */
    getAccessPatterns() {
        return {
            // Primary table access patterns
            'getUserById': 'PK = USER#{userId}, SK = PROFILE',
            'getUserCircles': 'PK = USER#{userId}, SK begins_with CIRCLE#',
            'getCircleById': 'PK = CIRCLE#{circleId}, SK = METADATA',
            'getCircleMembers': 'PK = CIRCLE#{circleId}, SK begins_with MEMBER#',
            'getStoryById': 'PK = STORY#{storyId}, SK = METADATA',
            'getStoryComments': 'PK = STORY#{storyId}, SK begins_with COMMENT#',
            'getBusinessById': 'PK = BUSINESS#{businessId}, SK = METADATA',
            'getResourceById': 'PK = RESOURCE#{resourceId}, SK = METADATA',
            // GSI1 access patterns (alternate keys)
            'getUserByEmail': 'GSI1PK = EMAIL#{email}, GSI1SK = USER#{userId}',
            'getCirclesByType': 'GSI1PK = CIRCLE_TYPE#{type}, GSI1SK = CREATED#{createdAt}',
            'getBusinessesByCategory': 'GSI1PK = BUSINESS_CATEGORY#{category}, GSI1SK = NAME#{name}',
            'getResourcesByType': 'GSI1PK = RESOURCE_TYPE#{type}, GSI1SK = CREATED#{createdAt}',
            // GSI2 access patterns (time-based)
            'getRecentStories': 'GSI2PK = STORY_FEED, GSI2SK = CREATED#{createdAt}',
            'getUserActivity': 'GSI2PK = USER_ACTIVITY#{userId}, GSI2SK = TIMESTAMP#{timestamp}',
            'getCircleActivity': 'GSI2PK = CIRCLE_ACTIVITY#{circleId}, GSI2SK = TIMESTAMP#{timestamp}',
            // GSI3 access patterns (status-based)
            'getPendingApprovals': 'GSI3PK = STATUS#PENDING, GSI3SK = CREATED#{createdAt}',
            'getActiveCircles': 'GSI3PK = CIRCLE_STATUS#ACTIVE, GSI3SK = UPDATED#{updatedAt}',
            'getPublishedStories': 'GSI3PK = STORY_STATUS#PUBLISHED, GSI3SK = CREATED#{createdAt}',
            // GSI4 access patterns (tenant-based)
            'getTenantUsers': 'GSI4PK = TENANT#{tenantId}#USERS, GSI4SK = CREATED#{createdAt}',
            'getTenantCircles': 'GSI4PK = TENANT#{tenantId}#CIRCLES, GSI4SK = CREATED#{createdAt}',
            'getTenantResources': 'GSI4PK = TENANT#{tenantId}#RESOURCES, GSI4SK = CREATED#{createdAt}',
        };
    }
}
exports.DatabaseConstruct = DatabaseConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29uc3RydWN0cy9kYXRhYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FBdUM7QUFDdkMsMkRBT2tDO0FBQ2xDLGlEQUE2RDtBQUM3RCw2Q0FBa0Q7QUEyQmxELE1BQWEsaUJBQWtCLFNBQVEsc0JBQVM7SUFJOUMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUE2QjtRQUNyRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sRUFDSixXQUFXLEVBQ1gseUJBQXlCLEdBQUcsSUFBSSxFQUNoQyxhQUFhLEdBQUcsSUFBSSxFQUNwQixhQUFhLEdBQUcsV0FBVyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsMkJBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLDJCQUFhLENBQUMsT0FBTyxHQUN0RixHQUFHLEtBQUssQ0FBQztRQUVWLHlDQUF5QztRQUN6QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksYUFBRyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUM1QyxXQUFXLEVBQUUsdUJBQXVCLFdBQVcsc0JBQXNCO1lBQ3JFLFFBQVEsRUFBRSxrQkFBUSxDQUFDLGVBQWU7WUFDbEMsT0FBTyxFQUFFLGlCQUFPLENBQUMsaUJBQWlCO1lBQ2xDLGlCQUFpQixFQUFFLElBQUk7WUFDdkIsYUFBYTtTQUNkLENBQUMsQ0FBQztRQUVILGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFdBQVcsV0FBVyxlQUFlLENBQUMsQ0FBQztRQUN4RSxrQkFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUVyRCwwREFBMEQ7UUFDMUQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLG9CQUFLLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRTtZQUM1QyxTQUFTLEVBQUUsV0FBVyxXQUFXLE9BQU87WUFDeEMsWUFBWSxFQUFFO2dCQUNaLElBQUksRUFBRSxJQUFJO2dCQUNWLElBQUksRUFBRSw0QkFBYSxDQUFDLE1BQU07YUFDM0I7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsSUFBSSxFQUFFLDRCQUFhLENBQUMsTUFBTTthQUMzQjtZQUNELFdBQVcsRUFBRSwwQkFBVyxDQUFDLGVBQWU7WUFDeEMsVUFBVSxFQUFFLDhCQUFlLENBQUMsZ0JBQWdCO1lBQzVDLGFBQWEsRUFBRSxJQUFJLENBQUMsTUFBTTtZQUMxQixtQkFBbUIsRUFBRSx5QkFBeUI7WUFDOUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsNkJBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNyRSxhQUFhO1lBQ2Isa0JBQWtCLEVBQUUsV0FBVyxLQUFLLE1BQU07U0FDM0MsQ0FBQyxDQUFDO1FBRUgsc0NBQXNDO1FBQ3RDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1FBRWpDLFdBQVc7UUFDWCxrQkFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxXQUFXLFdBQVcsYUFBYSxDQUFDLENBQUM7UUFDekUsa0JBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDeEQsa0JBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsMENBQTBDLENBQUMsQ0FBQztJQUNyRixDQUFDO0lBRU8seUJBQXlCO1FBQy9CLGdGQUFnRjtRQUNoRixJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDO1lBQ3JDLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFlBQVksRUFBRTtnQkFDWixJQUFJLEVBQUUsUUFBUTtnQkFDZCxJQUFJLEVBQUUsNEJBQWEsQ0FBQyxNQUFNO2FBQzNCO1lBQ0QsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxRQUFRO2dCQUNkLElBQUksRUFBRSw0QkFBYSxDQUFDLE1BQU07YUFDM0I7WUFDRCxjQUFjLEVBQUUsNkJBQWMsQ0FBQyxHQUFHO1NBQ25DLENBQUMsQ0FBQztRQUVILDJDQUEyQztRQUMzQyxJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDO1lBQ3JDLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFlBQVksRUFBRTtnQkFDWixJQUFJLEVBQUUsUUFBUTtnQkFDZCxJQUFJLEVBQUUsNEJBQWEsQ0FBQyxNQUFNO2FBQzNCO1lBQ0QsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxRQUFRO2dCQUNkLElBQUksRUFBRSw0QkFBYSxDQUFDLE1BQU07YUFDM0I7WUFDRCxjQUFjLEVBQUUsNkJBQWMsQ0FBQyxHQUFHO1NBQ25DLENBQUMsQ0FBQztRQUVILCtDQUErQztRQUMvQyxJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDO1lBQ3JDLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFlBQVksRUFBRTtnQkFDWixJQUFJLEVBQUUsUUFBUTtnQkFDZCxJQUFJLEVBQUUsNEJBQWEsQ0FBQyxNQUFNO2FBQzNCO1lBQ0QsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxRQUFRO2dCQUNkLElBQUksRUFBRSw0QkFBYSxDQUFDLE1BQU07YUFDM0I7WUFDRCxjQUFjLEVBQUUsNkJBQWMsQ0FBQyxTQUFTO1NBQ3pDLENBQUMsQ0FBQztRQUVILHlEQUF5RDtRQUN6RCxJQUFJLENBQUMsU0FBUyxDQUFDLHVCQUF1QixDQUFDO1lBQ3JDLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFlBQVksRUFBRTtnQkFDWixJQUFJLEVBQUUsUUFBUTtnQkFDZCxJQUFJLEVBQUUsNEJBQWEsQ0FBQyxNQUFNO2FBQzNCO1lBQ0QsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxRQUFRO2dCQUNkLElBQUksRUFBRSw0QkFBYSxDQUFDLE1BQU07YUFDM0I7WUFDRCxjQUFjLEVBQUUsNkJBQWMsQ0FBQyxPQUFPO1lBQ3RDLGdCQUFnQixFQUFFLENBQUMsWUFBWSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsV0FBVyxDQUFDO1NBQ3JFLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNJLGlCQUFpQjtRQUN0QixPQUFPO1lBQ0wsZ0NBQWdDO1lBQ2hDLGFBQWEsRUFBRSxrQ0FBa0M7WUFDakQsZ0JBQWdCLEVBQUUsNENBQTRDO1lBQzlELGVBQWUsRUFBRSx1Q0FBdUM7WUFDeEQsa0JBQWtCLEVBQUUsZ0RBQWdEO1lBQ3BFLGNBQWMsRUFBRSxxQ0FBcUM7WUFDckQsa0JBQWtCLEVBQUUsK0NBQStDO1lBQ25FLGlCQUFpQixFQUFFLDJDQUEyQztZQUM5RCxpQkFBaUIsRUFBRSwyQ0FBMkM7WUFFOUQsd0NBQXdDO1lBQ3hDLGdCQUFnQixFQUFFLGdEQUFnRDtZQUNsRSxrQkFBa0IsRUFBRSwyREFBMkQ7WUFDL0UseUJBQXlCLEVBQUUsNkRBQTZEO1lBQ3hGLG9CQUFvQixFQUFFLDZEQUE2RDtZQUVuRixvQ0FBb0M7WUFDcEMsa0JBQWtCLEVBQUUsbURBQW1EO1lBQ3ZFLGlCQUFpQixFQUFFLGlFQUFpRTtZQUNwRixtQkFBbUIsRUFBRSxxRUFBcUU7WUFFMUYsc0NBQXNDO1lBQ3RDLHFCQUFxQixFQUFFLHVEQUF1RDtZQUM5RSxrQkFBa0IsRUFBRSw2REFBNkQ7WUFDakYscUJBQXFCLEVBQUUsK0RBQStEO1lBRXRGLHNDQUFzQztZQUN0QyxnQkFBZ0IsRUFBRSxnRUFBZ0U7WUFDbEYsa0JBQWtCLEVBQUUsa0VBQWtFO1lBQ3RGLG9CQUFvQixFQUFFLG9FQUFvRTtTQUMzRixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBdkpELDhDQXVKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgVGFibGUsXG4gIEF0dHJpYnV0ZVR5cGUsXG4gIEJpbGxpbmdNb2RlLFxuICBQcm9qZWN0aW9uVHlwZSxcbiAgU3RyZWFtVmlld1R5cGUsXG4gIFRhYmxlRW5jcnlwdGlvbixcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCB7IEtleSwgS2V5U3BlYywgS2V5VXNhZ2UgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mta21zJztcbmltcG9ydCB7IFJlbW92YWxQb2xpY3ksIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0YWJhc2VDb25zdHJ1Y3RQcm9wcyB7XG4gIC8qKlxuICAgKiBFbnZpcm9ubWVudCBuYW1lIChkZXYsIHN0YWdpbmcsIHByb2QpXG4gICAqL1xuICBlbnZpcm9ubWVudDogc3RyaW5nO1xuICBcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZW5hYmxlIHBvaW50LWluLXRpbWUgcmVjb3ZlcnlcbiAgICogQGRlZmF1bHQgdHJ1ZVxuICAgKi9cbiAgZW5hYmxlUG9pbnRJblRpbWVSZWNvdmVyeT86IGJvb2xlYW47XG4gIFxuICAvKipcbiAgICogV2hldGhlciB0byBlbmFibGUgRHluYW1vREIgc3RyZWFtc1xuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICBlbmFibGVTdHJlYW1zPzogYm9vbGVhbjtcbiAgXG4gIC8qKlxuICAgKiBSZW1vdmFsIHBvbGljeSBmb3IgdGhlIHRhYmxlXG4gICAqIEBkZWZhdWx0IFJlbW92YWxQb2xpY3kuUkVUQUlOIGZvciBwcm9kLCBSZW1vdmFsUG9saWN5LkRFU1RST1kgZm9yIG90aGVyc1xuICAgKi9cbiAgcmVtb3ZhbFBvbGljeT86IFJlbW92YWxQb2xpY3k7XG59XG5cbmV4cG9ydCBjbGFzcyBEYXRhYmFzZUNvbnN0cnVjdCBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBtYWluVGFibGU6IFRhYmxlO1xuICBwdWJsaWMgcmVhZG9ubHkga21zS2V5OiBLZXk7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IERhdGFiYXNlQ29uc3RydWN0UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qge1xuICAgICAgZW52aXJvbm1lbnQsXG4gICAgICBlbmFibGVQb2ludEluVGltZVJlY292ZXJ5ID0gdHJ1ZSxcbiAgICAgIGVuYWJsZVN0cmVhbXMgPSB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeSA9IGVudmlyb25tZW50ID09PSAncHJvZCcgPyBSZW1vdmFsUG9saWN5LlJFVEFJTiA6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9ID0gcHJvcHM7XG5cbiAgICAvLyBDcmVhdGUgS01TIGtleSBmb3IgRHluYW1vREIgZW5jcnlwdGlvblxuICAgIHRoaXMua21zS2V5ID0gbmV3IEtleSh0aGlzLCAnRGF0YWJhc2VLbXNLZXknLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYEtNUyBrZXkgZm9yIE1BRE1hbGwgJHtlbnZpcm9ubWVudH0gRHluYW1vREIgZW5jcnlwdGlvbmAsXG4gICAgICBrZXlVc2FnZTogS2V5VXNhZ2UuRU5DUllQVF9ERUNSWVBULFxuICAgICAga2V5U3BlYzogS2V5U3BlYy5TWU1NRVRSSUNfREVGQVVMVCxcbiAgICAgIGVuYWJsZUtleVJvdGF0aW9uOiB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeSxcbiAgICB9KTtcblxuICAgIFRhZ3Mub2YodGhpcy5rbXNLZXkpLmFkZCgnTmFtZScsIGBtYWRtYWxsLSR7ZW52aXJvbm1lbnR9LWR5bmFtb2RiLWtleWApO1xuICAgIFRhZ3Mub2YodGhpcy5rbXNLZXkpLmFkZCgnRW52aXJvbm1lbnQnLCBlbnZpcm9ubWVudCk7XG5cbiAgICAvLyBDcmVhdGUgdGhlIG1haW4gRHluYW1vREIgdGFibGUgd2l0aCBzaW5nbGUtdGFibGUgZGVzaWduXG4gICAgdGhpcy5tYWluVGFibGUgPSBuZXcgVGFibGUodGhpcywgJ01haW5UYWJsZScsIHtcbiAgICAgIHRhYmxlTmFtZTogYG1hZG1hbGwtJHtlbnZpcm9ubWVudH0tbWFpbmAsXG4gICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgbmFtZTogJ1BLJyxcbiAgICAgICAgdHlwZTogQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICB9LFxuICAgICAgc29ydEtleToge1xuICAgICAgICBuYW1lOiAnU0snLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBiaWxsaW5nTW9kZTogQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgZW5jcnlwdGlvbjogVGFibGVFbmNyeXB0aW9uLkNVU1RPTUVSX01BTkFHRUQsXG4gICAgICBlbmNyeXB0aW9uS2V5OiB0aGlzLmttc0tleSxcbiAgICAgIHBvaW50SW5UaW1lUmVjb3Zlcnk6IGVuYWJsZVBvaW50SW5UaW1lUmVjb3ZlcnksXG4gICAgICBzdHJlYW06IGVuYWJsZVN0cmVhbXMgPyBTdHJlYW1WaWV3VHlwZS5ORVdfQU5EX09MRF9JTUFHRVMgOiB1bmRlZmluZWQsXG4gICAgICByZW1vdmFsUG9saWN5LFxuICAgICAgZGVsZXRpb25Qcm90ZWN0aW9uOiBlbnZpcm9ubWVudCA9PT0gJ3Byb2QnLFxuICAgIH0pO1xuXG4gICAgLy8gQWRkIEdsb2JhbCBTZWNvbmRhcnkgSW5kZXhlcyAoR1NJcylcbiAgICB0aGlzLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4ZXMoKTtcblxuICAgIC8vIEFkZCB0YWdzXG4gICAgVGFncy5vZih0aGlzLm1haW5UYWJsZSkuYWRkKCdOYW1lJywgYG1hZG1hbGwtJHtlbnZpcm9ubWVudH0tbWFpbi10YWJsZWApO1xuICAgIFRhZ3Mub2YodGhpcy5tYWluVGFibGUpLmFkZCgnRW52aXJvbm1lbnQnLCBlbnZpcm9ubWVudCk7XG4gICAgVGFncy5vZih0aGlzLm1haW5UYWJsZSkuYWRkKCdQdXJwb3NlJywgJ1NpbmdsZS10YWJsZSBkZXNpZ24gZm9yIE1BRE1hbGwgcGxhdGZvcm0nKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkR2xvYmFsU2Vjb25kYXJ5SW5kZXhlcygpOiB2b2lkIHtcbiAgICAvLyBHU0kxOiBGb3IgYWx0ZXJuYXRlIGFjY2VzcyBwYXR0ZXJucyAoZS5nLiwgZW1haWwgbG9va3VwcywgdHlwZS1iYXNlZCBxdWVyaWVzKVxuICAgIHRoaXMubWFpblRhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgIGluZGV4TmFtZTogJ0dTSTEnLFxuICAgICAgcGFydGl0aW9uS2V5OiB7XG4gICAgICAgIG5hbWU6ICdHU0kxUEsnLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBzb3J0S2V5OiB7XG4gICAgICAgIG5hbWU6ICdHU0kxU0snLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBwcm9qZWN0aW9uVHlwZTogUHJvamVjdGlvblR5cGUuQUxMLFxuICAgIH0pO1xuXG4gICAgLy8gR1NJMjogRm9yIHRpbWUtYmFzZWQgcXVlcmllcyBhbmQgc29ydGluZ1xuICAgIHRoaXMubWFpblRhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgIGluZGV4TmFtZTogJ0dTSTInLFxuICAgICAgcGFydGl0aW9uS2V5OiB7XG4gICAgICAgIG5hbWU6ICdHU0kyUEsnLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBzb3J0S2V5OiB7XG4gICAgICAgIG5hbWU6ICdHU0kyU0snLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBwcm9qZWN0aW9uVHlwZTogUHJvamVjdGlvblR5cGUuQUxMLFxuICAgIH0pO1xuXG4gICAgLy8gR1NJMzogRm9yIHN0YXR1cy1iYXNlZCBxdWVyaWVzIGFuZCBmaWx0ZXJpbmdcbiAgICB0aGlzLm1haW5UYWJsZS5hZGRHbG9iYWxTZWNvbmRhcnlJbmRleCh7XG4gICAgICBpbmRleE5hbWU6ICdHU0kzJyxcbiAgICAgIHBhcnRpdGlvbktleToge1xuICAgICAgICBuYW1lOiAnR1NJM1BLJyxcbiAgICAgICAgdHlwZTogQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICB9LFxuICAgICAgc29ydEtleToge1xuICAgICAgICBuYW1lOiAnR1NJM1NLJyxcbiAgICAgICAgdHlwZTogQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICB9LFxuICAgICAgcHJvamVjdGlvblR5cGU6IFByb2plY3Rpb25UeXBlLktFWVNfT05MWSxcbiAgICB9KTtcblxuICAgIC8vIEdTSTQ6IEZvciB0ZW5hbnQtYmFzZWQgcXVlcmllcyAobXVsdGktdGVuYW5jeSBzdXBwb3J0KVxuICAgIHRoaXMubWFpblRhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgIGluZGV4TmFtZTogJ0dTSTQnLFxuICAgICAgcGFydGl0aW9uS2V5OiB7XG4gICAgICAgIG5hbWU6ICdHU0k0UEsnLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBzb3J0S2V5OiB7XG4gICAgICAgIG5hbWU6ICdHU0k0U0snLFxuICAgICAgICB0eXBlOiBBdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgICBwcm9qZWN0aW9uVHlwZTogUHJvamVjdGlvblR5cGUuSU5DTFVERSxcbiAgICAgIG5vbktleUF0dHJpYnV0ZXM6IFsnZW50aXR5VHlwZScsICdzdGF0dXMnLCAnY3JlYXRlZEF0JywgJ3VwZGF0ZWRBdCddLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhY2Nlc3MgcGF0dGVybnMgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIHNpbmdsZS10YWJsZSBkZXNpZ25cbiAgICovXG4gIHB1YmxpYyBnZXRBY2Nlc3NQYXR0ZXJucygpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICByZXR1cm4ge1xuICAgICAgLy8gUHJpbWFyeSB0YWJsZSBhY2Nlc3MgcGF0dGVybnNcbiAgICAgICdnZXRVc2VyQnlJZCc6ICdQSyA9IFVTRVIje3VzZXJJZH0sIFNLID0gUFJPRklMRScsXG4gICAgICAnZ2V0VXNlckNpcmNsZXMnOiAnUEsgPSBVU0VSI3t1c2VySWR9LCBTSyBiZWdpbnNfd2l0aCBDSVJDTEUjJyxcbiAgICAgICdnZXRDaXJjbGVCeUlkJzogJ1BLID0gQ0lSQ0xFI3tjaXJjbGVJZH0sIFNLID0gTUVUQURBVEEnLFxuICAgICAgJ2dldENpcmNsZU1lbWJlcnMnOiAnUEsgPSBDSVJDTEUje2NpcmNsZUlkfSwgU0sgYmVnaW5zX3dpdGggTUVNQkVSIycsXG4gICAgICAnZ2V0U3RvcnlCeUlkJzogJ1BLID0gU1RPUlkje3N0b3J5SWR9LCBTSyA9IE1FVEFEQVRBJyxcbiAgICAgICdnZXRTdG9yeUNvbW1lbnRzJzogJ1BLID0gU1RPUlkje3N0b3J5SWR9LCBTSyBiZWdpbnNfd2l0aCBDT01NRU5UIycsXG4gICAgICAnZ2V0QnVzaW5lc3NCeUlkJzogJ1BLID0gQlVTSU5FU1Mje2J1c2luZXNzSWR9LCBTSyA9IE1FVEFEQVRBJyxcbiAgICAgICdnZXRSZXNvdXJjZUJ5SWQnOiAnUEsgPSBSRVNPVVJDRSN7cmVzb3VyY2VJZH0sIFNLID0gTUVUQURBVEEnLFxuICAgICAgXG4gICAgICAvLyBHU0kxIGFjY2VzcyBwYXR0ZXJucyAoYWx0ZXJuYXRlIGtleXMpXG4gICAgICAnZ2V0VXNlckJ5RW1haWwnOiAnR1NJMVBLID0gRU1BSUwje2VtYWlsfSwgR1NJMVNLID0gVVNFUiN7dXNlcklkfScsXG4gICAgICAnZ2V0Q2lyY2xlc0J5VHlwZSc6ICdHU0kxUEsgPSBDSVJDTEVfVFlQRSN7dHlwZX0sIEdTSTFTSyA9IENSRUFURUQje2NyZWF0ZWRBdH0nLFxuICAgICAgJ2dldEJ1c2luZXNzZXNCeUNhdGVnb3J5JzogJ0dTSTFQSyA9IEJVU0lORVNTX0NBVEVHT1JZI3tjYXRlZ29yeX0sIEdTSTFTSyA9IE5BTUUje25hbWV9JyxcbiAgICAgICdnZXRSZXNvdXJjZXNCeVR5cGUnOiAnR1NJMVBLID0gUkVTT1VSQ0VfVFlQRSN7dHlwZX0sIEdTSTFTSyA9IENSRUFURUQje2NyZWF0ZWRBdH0nLFxuICAgICAgXG4gICAgICAvLyBHU0kyIGFjY2VzcyBwYXR0ZXJucyAodGltZS1iYXNlZClcbiAgICAgICdnZXRSZWNlbnRTdG9yaWVzJzogJ0dTSTJQSyA9IFNUT1JZX0ZFRUQsIEdTSTJTSyA9IENSRUFURUQje2NyZWF0ZWRBdH0nLFxuICAgICAgJ2dldFVzZXJBY3Rpdml0eSc6ICdHU0kyUEsgPSBVU0VSX0FDVElWSVRZI3t1c2VySWR9LCBHU0kyU0sgPSBUSU1FU1RBTVAje3RpbWVzdGFtcH0nLFxuICAgICAgJ2dldENpcmNsZUFjdGl2aXR5JzogJ0dTSTJQSyA9IENJUkNMRV9BQ1RJVklUWSN7Y2lyY2xlSWR9LCBHU0kyU0sgPSBUSU1FU1RBTVAje3RpbWVzdGFtcH0nLFxuICAgICAgXG4gICAgICAvLyBHU0kzIGFjY2VzcyBwYXR0ZXJucyAoc3RhdHVzLWJhc2VkKVxuICAgICAgJ2dldFBlbmRpbmdBcHByb3ZhbHMnOiAnR1NJM1BLID0gU1RBVFVTI1BFTkRJTkcsIEdTSTNTSyA9IENSRUFURUQje2NyZWF0ZWRBdH0nLFxuICAgICAgJ2dldEFjdGl2ZUNpcmNsZXMnOiAnR1NJM1BLID0gQ0lSQ0xFX1NUQVRVUyNBQ1RJVkUsIEdTSTNTSyA9IFVQREFURUQje3VwZGF0ZWRBdH0nLFxuICAgICAgJ2dldFB1Ymxpc2hlZFN0b3JpZXMnOiAnR1NJM1BLID0gU1RPUllfU1RBVFVTI1BVQkxJU0hFRCwgR1NJM1NLID0gQ1JFQVRFRCN7Y3JlYXRlZEF0fScsXG4gICAgICBcbiAgICAgIC8vIEdTSTQgYWNjZXNzIHBhdHRlcm5zICh0ZW5hbnQtYmFzZWQpXG4gICAgICAnZ2V0VGVuYW50VXNlcnMnOiAnR1NJNFBLID0gVEVOQU5UI3t0ZW5hbnRJZH0jVVNFUlMsIEdTSTRTSyA9IENSRUFURUQje2NyZWF0ZWRBdH0nLFxuICAgICAgJ2dldFRlbmFudENpcmNsZXMnOiAnR1NJNFBLID0gVEVOQU5UI3t0ZW5hbnRJZH0jQ0lSQ0xFUywgR1NJNFNLID0gQ1JFQVRFRCN7Y3JlYXRlZEF0fScsXG4gICAgICAnZ2V0VGVuYW50UmVzb3VyY2VzJzogJ0dTSTRQSyA9IFRFTkFOVCN7dGVuYW50SWR9I1JFU09VUkNFUywgR1NJNFNLID0gQ1JFQVRFRCN7Y3JlYXRlZEF0fScsXG4gICAgfTtcbiAgfVxufSJdfQ==