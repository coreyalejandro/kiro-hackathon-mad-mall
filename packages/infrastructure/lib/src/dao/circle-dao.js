"use strict";
/**
 * Circle DAO Implementation
 * Data access operations for Circle entities
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CircleDynamoDAO = void 0;
const base_dao_1 = require("./base-dao");
const database_1 = require("@madmall/shared-types/database");
const database_2 = require("@madmall/shared-types/database");
class CircleDynamoDAO extends base_dao_1.BaseDynamoDAO {
    constructor(dynamoService) {
        super(dynamoService, 'CIRCLE');
    }
    /**
     * Entity-specific validation for circles
     */
    validateEntitySpecific(entity) {
        return database_2.DataValidator.validateCircle(entity);
    }
    /**
     * Get circles by type using GSI1
     */
    async getByType(type, options) {
        return await this.queryGSI('GSI1', `CIRCLE_TYPE#${type}`, undefined, options);
    }
    /**
     * Get circle members
     */
    async getMembers(circleId, options) {
        const keyConditionExpression = 'PK = :pk AND begins_with(SK, :skPrefix)';
        const expressionAttributeValues = {
            ':pk': `CIRCLE#${circleId}`,
            ':skPrefix': 'MEMBER#',
        };
        return await this.dynamoService.query(keyConditionExpression, {
            ...options,
            expressionAttributeValues: {
                ...expressionAttributeValues,
                ...options?.expressionAttributeValues,
            },
        });
    }
    /**
     * Add member to circle
     */
    async addMember(circleId, userId, role = 'member') {
        const now = new Date().toISOString();
        const member = {
            PK: `CIRCLE#${circleId}`,
            SK: `MEMBER#${userId}`,
            GSI3PK: `MEMBER_STATUS#active`,
            GSI3SK: `JOINED#${now}`,
            entityType: 'CIRCLE_MEMBER',
            version: 1,
            createdAt: now,
            updatedAt: now,
            circleId,
            userId,
            role,
            status: 'active',
            joinedAt: now,
            lastActive: now,
            contributionScore: 0,
            badges: [],
        };
        // Also create reverse relationship for user's circles
        const userCircleRelation = {
            ...member,
            PK: `USER#${userId}`,
            SK: `CIRCLE#${circleId}`,
        };
        // Use transaction to ensure both records are created
        await this.dynamoService.transaction([
            {
                operation: 'put',
                item: member,
            },
            {
                operation: 'put',
                item: userCircleRelation,
            },
        ]);
        // Update circle member count
        await this.updateStats(circleId, { memberCount: 1 });
        return member;
    }
    /**
     * Remove member from circle
     */
    async removeMember(circleId, userId) {
        // Use transaction to remove both relationships
        await this.dynamoService.transaction([
            {
                operation: 'delete',
                key: { PK: `CIRCLE#${circleId}`, SK: `MEMBER#${userId}` },
            },
            {
                operation: 'delete',
                key: { PK: `USER#${userId}`, SK: `CIRCLE#${circleId}` },
            },
        ]);
        // Update circle member count
        await this.updateStats(circleId, { memberCount: -1 });
    }
    /**
     * Update member role
     */
    async updateMemberRole(circleId, userId, role) {
        const now = new Date().toISOString();
        // Update both relationship records
        await this.dynamoService.transaction([
            {
                operation: 'update',
                key: { PK: `CIRCLE#${circleId}`, SK: `MEMBER#${userId}` },
                updateExpression: 'SET #role = :role, #updatedAt = :updatedAt, #version = #version + :inc',
                expressionAttributeNames: {
                    '#role': 'role',
                    '#updatedAt': 'updatedAt',
                    '#version': 'version',
                },
                expressionAttributeValues: {
                    ':role': role,
                    ':updatedAt': now,
                    ':inc': 1,
                },
            },
            {
                operation: 'update',
                key: { PK: `USER#${userId}`, SK: `CIRCLE#${circleId}` },
                updateExpression: 'SET #role = :role, #updatedAt = :updatedAt, #version = #version + :inc',
                expressionAttributeNames: {
                    '#role': 'role',
                    '#updatedAt': 'updatedAt',
                    '#version': 'version',
                },
                expressionAttributeValues: {
                    ':role': role,
                    ':updatedAt': now,
                    ':inc': 1,
                },
            },
        ]);
    }
    /**
     * Get active circles using GSI3
     */
    async getActiveCircles(options) {
        return await this.queryGSI('GSI3', 'CIRCLE_STATUS#ACTIVE', undefined, options);
    }
    /**
     * Search circles by criteria
     */
    async searchCircles(criteria, options) {
        let baseQuery;
        // Start with type-based query if type is specified
        if (criteria.type) {
            baseQuery = this.getByType(criteria.type, options);
        }
        else {
            // Otherwise get all active circles
            baseQuery = this.getActiveCircles(options);
        }
        const result = await baseQuery;
        // Apply additional filters in memory (for better performance, consider using search service)
        let filteredItems = result.items;
        if (criteria.culturalFocus && criteria.culturalFocus.length > 0) {
            filteredItems = filteredItems.filter(circle => circle.settings.culturalFocus?.some(focus => criteria.culturalFocus.includes(focus)));
        }
        if (criteria.tags && criteria.tags.length > 0) {
            filteredItems = filteredItems.filter(circle => circle.tags.some(tag => criteria.tags.includes(tag)));
        }
        if (criteria.isPrivate !== undefined) {
            filteredItems = filteredItems.filter(circle => circle.settings.isPrivate === criteria.isPrivate);
        }
        return {
            ...result,
            items: filteredItems,
            count: filteredItems.length,
        };
    }
    /**
     * Update circle statistics
     */
    async updateStats(circleId, stats) {
        const { PK, SK } = database_1.KeyPatterns.CIRCLE_METADATA(circleId);
        const updateExpressions = [];
        const expressionAttributeNames = {
            '#updatedAt': 'updatedAt',
            '#version': 'version',
        };
        const expressionAttributeValues = {
            ':updatedAt': new Date().toISOString(),
            ':versionIncrement': 1,
        };
        // Build update expressions for each stat
        Object.entries(stats).forEach(([statName, value]) => {
            if (value !== undefined) {
                const attrName = `#stats_${statName}`;
                const attrValue = `:${statName}`;
                if (typeof value === 'number' && (statName === 'memberCount' || statName === 'postsThisWeek' || statName === 'postsThisMonth')) {
                    // For counts, use ADD operation to increment/decrement
                    updateExpressions.push(`#stats.${attrName} = if_not_exists(#stats.${attrName}, :zero) + ${attrValue}`);
                    expressionAttributeValues[':zero'] = 0;
                }
                else {
                    // For rates and averages, use SET operation
                    updateExpressions.push(`#stats.${attrName} = ${attrValue}`);
                }
                expressionAttributeNames['#stats'] = 'stats';
                expressionAttributeNames[attrName] = statName;
                expressionAttributeValues[attrValue] = value;
            }
        });
        if (updateExpressions.length > 0) {
            updateExpressions.push('#updatedAt = :updatedAt');
            updateExpressions.push('#version = #version + :versionIncrement');
            await this.dynamoService.updateItem(PK, SK, {
                updateExpression: `SET ${updateExpressions.join(', ')}`,
                expressionAttributeNames,
                expressionAttributeValues,
            });
        }
    }
    /**
     * Create circle with proper key generation
     */
    async create(item) {
        const now = new Date().toISOString();
        // Generate keys using patterns
        const { PK, SK } = database_1.KeyPatterns.CIRCLE_METADATA(item.circleId);
        const newCircle = {
            ...item,
            PK,
            SK,
            GSI1PK: `CIRCLE_TYPE#${item.type}`,
            GSI1SK: `CREATED#${now}`,
            GSI3PK: `CIRCLE_STATUS#${item.status || 'ACTIVE'}`,
            GSI3SK: `UPDATED#${now}`,
            GSI4PK: `TENANT#${item.tenantId || 'default'}#CIRCLES`,
            GSI4SK: `CREATED#${now}`,
            entityType: 'CIRCLE',
            version: 1,
            createdAt: now,
            updatedAt: now,
            status: item.status || 'ACTIVE',
        };
        // Validate before creating
        const validation = this.validateEntitySpecific(newCircle);
        if (!validation.isValid) {
            throw new Error(`Circle validation failed: ${validation.errors.map(e => e.message).join(', ')}`);
        }
        const createdCircle = await this.dynamoService.putItem(newCircle);
        // Add creator as first member with admin role
        await this.addMember(item.circleId, item.createdBy, 'admin');
        return createdCircle;
    }
    /**
     * Get circle by ID (convenience method)
     */
    async getCircleById(circleId) {
        const { PK, SK } = database_1.KeyPatterns.CIRCLE_METADATA(circleId);
        return await this.getById(PK, SK);
    }
    /**
     * Update circle settings
     */
    async updateSettings(circleId, settingsUpdates) {
        const { PK, SK } = database_1.KeyPatterns.CIRCLE_METADATA(circleId);
        const updateExpressions = [];
        const expressionAttributeNames = {
            '#updatedAt': 'updatedAt',
            '#version': 'version',
        };
        const expressionAttributeValues = {
            ':updatedAt': new Date().toISOString(),
            ':versionIncrement': 1,
        };
        // Build update expressions for settings fields
        Object.entries(settingsUpdates).forEach(([field, value]) => {
            const attrName = `#settings_${field}`;
            const attrValue = `:settings_${field}`;
            updateExpressions.push(`#settings.${attrName} = ${attrValue}`);
            expressionAttributeNames['#settings'] = 'settings';
            expressionAttributeNames[attrName] = field;
            expressionAttributeValues[attrValue] = value;
        });
        updateExpressions.push('#updatedAt = :updatedAt');
        updateExpressions.push('#version = #version + :versionIncrement');
        return await this.dynamoService.updateItem(PK, SK, {
            updateExpression: `SET ${updateExpressions.join(', ')}`,
            expressionAttributeNames,
            expressionAttributeValues,
            returnValues: 'ALL_NEW',
        });
    }
    /**
     * Get member by circle and user ID
     */
    async getMember(circleId, userId) {
        const { PK, SK } = database_1.KeyPatterns.CIRCLE_MEMBER(circleId, userId);
        return await this.dynamoService.getItem(PK, SK);
    }
    /**
     * Check if user is member of circle
     */
    async isMember(circleId, userId) {
        const member = await this.getMember(circleId, userId);
        return member !== null && member.status === 'active';
    }
    /**
     * Get circles by member status using GSI3
     */
    async getCirclesByMemberStatus(status, options) {
        return await this.queryGSI('GSI3', `MEMBER_STATUS#${status}`, undefined, options);
    }
}
exports.CircleDynamoDAO = CircleDynamoDAO;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2lyY2xlLWRhby5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYW8vY2lyY2xlLWRhby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCx5Q0FBMkM7QUFFM0MsNkRBQW1HO0FBQ25HLDZEQUFpRjtBQUdqRixNQUFhLGVBQWdCLFNBQVEsd0JBQTZCO0lBQ2hFLFlBQVksYUFBOEI7UUFDeEMsS0FBSyxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDTyxzQkFBc0IsQ0FBQyxNQUFzQjtRQUNyRCxPQUFPLHdCQUFhLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBWSxFQUFFLE9BQXNCO1FBQ2xELE9BQU8sTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxlQUFlLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoRixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQWdCLEVBQUUsT0FBc0I7UUFDdkQsTUFBTSxzQkFBc0IsR0FBRyx5Q0FBeUMsQ0FBQztRQUN6RSxNQUFNLHlCQUF5QixHQUFHO1lBQ2hDLEtBQUssRUFBRSxVQUFVLFFBQVEsRUFBRTtZQUMzQixXQUFXLEVBQUUsU0FBUztTQUN2QixDQUFDO1FBRUYsT0FBTyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUF1QixzQkFBc0IsRUFBRTtZQUNsRixHQUFHLE9BQU87WUFDVix5QkFBeUIsRUFBRTtnQkFDekIsR0FBRyx5QkFBeUI7Z0JBQzVCLEdBQUcsT0FBTyxFQUFFLHlCQUF5QjthQUN0QztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxTQUFTLENBQUMsUUFB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QUMsU0FBUyxDQUFDLFFBQWdCLEVBQUUsTUFBYztRQUM5QyxNQUFNLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLHNCQUFXLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMvRCxPQUFPLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQXVCLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQWdCLEVBQUUsTUFBYztRQUM3QyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3RELE9BQU8sTUFBTSxLQUFLLElBQUksSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLFFBQVEsQ0FBQztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsd0JBQXdCLENBQUMsTUFBYyxFQUFFLE9BQXNCO1FBQ25FLE9BQU8sTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxpQkFBaUIsTUFBTSxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3BGLENBQUM7Q0FDRjtBQW5YRCwwQ0FtWEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENpcmNsZSBEQU8gSW1wbGVtZW50YXRpb25cbiAqIERhdGEgYWNjZXNzIG9wZXJhdGlvbnMgZm9yIENpcmNsZSBlbnRpdGllc1xuICovXG5cbmltcG9ydCB7IEJhc2VEeW5hbW9EQU8gfSBmcm9tICcuL2Jhc2UtZGFvJztcbmltcG9ydCB7IENpcmNsZURBTywgUXVlcnlPcHRpb25zLCBRdWVyeVJlc3VsdCB9IGZyb20gJ0BtYWRtYWxsL3NoYXJlZC10eXBlcy9kYXRhYmFzZSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNpcmNsZSwgRHluYW1vREJDaXJjbGVNZW1iZXIsIEtleVBhdHRlcm5zIH0gZnJvbSAnQG1hZG1hbGwvc2hhcmVkLXR5cGVzL2RhdGFiYXNlJztcbmltcG9ydCB7IERhdGFWYWxpZGF0b3IsIFZhbGlkYXRpb25SZXN1bHQgfSBmcm9tICdAbWFkbWFsbC9zaGFyZWQtdHlwZXMvZGF0YWJhc2UnO1xuaW1wb3J0IHsgRHluYW1vREJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZHluYW1vZGItc2VydmljZSc7XG5cbmV4cG9ydCBjbGFzcyBDaXJjbGVEeW5hbW9EQU8gZXh0ZW5kcyBCYXNlRHluYW1vREFPPER5bmFtb0RCQ2lyY2xlPiBpbXBsZW1lbnRzIENpcmNsZURBTyB7XG4gIGNvbnN0cnVjdG9yKGR5bmFtb1NlcnZpY2U6IER5bmFtb0RCU2VydmljZSkge1xuICAgIHN1cGVyKGR5bmFtb1NlcnZpY2UsICdDSVJDTEUnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbnRpdHktc3BlY2lmaWMgdmFsaWRhdGlvbiBmb3IgY2lyY2xlc1xuICAgKi9cbiAgcHJvdGVjdGVkIHZhbGlkYXRlRW50aXR5U3BlY2lmaWMoZW50aXR5OiBEeW5hbW9EQkNpcmNsZSk6IFZhbGlkYXRpb25SZXN1bHQge1xuICAgIHJldHVybiBEYXRhVmFsaWRhdG9yLnZhbGlkYXRlQ2lyY2xlKGVudGl0eSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNpcmNsZXMgYnkgdHlwZSB1c2luZyBHU0kxXG4gICAqL1xuICBhc3luYyBnZXRCeVR5cGUodHlwZTogc3RyaW5nLCBvcHRpb25zPzogUXVlcnlPcHRpb25zKTogUHJvbWlzZTxRdWVyeVJlc3VsdDxEeW5hbW9EQkNpcmNsZT4+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5xdWVyeUdTSSgnR1NJMScsIGBDSVJDTEVfVFlQRSMke3R5cGV9YCwgdW5kZWZpbmVkLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2lyY2xlIG1lbWJlcnNcbiAgICovXG4gIGFzeW5jIGdldE1lbWJlcnMoY2lyY2xlSWQ6IHN0cmluZywgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucyk6IFByb21pc2U8UXVlcnlSZXN1bHQ8RHluYW1vREJDaXJjbGVNZW1iZXI+PiB7XG4gICAgY29uc3Qga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiA9ICdQSyA9IDpwayBBTkQgYmVnaW5zX3dpdGgoU0ssIDpza1ByZWZpeCknO1xuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7XG4gICAgICAnOnBrJzogYENJUkNMRSMke2NpcmNsZUlkfWAsXG4gICAgICAnOnNrUHJlZml4JzogJ01FTUJFUiMnLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5keW5hbW9TZXJ2aWNlLnF1ZXJ5PER5bmFtb0RCQ2lyY2xlTWVtYmVyPihrZXlDb25kaXRpb25FeHByZXNzaW9uLCB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAuLi5leHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAuLi5vcHRpb25zPy5leHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgbWVtYmVyIHRvIGNpcmNsZVxuICAgKi9cbiAgYXN5bmMgYWRkTWVtYmVyKGNpcmNsZUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCByb2xlOiBzdHJpbmcgPSAnbWVtYmVyJyk6IFByb21pc2U8RHluYW1vREJDaXJjbGVNZW1iZXI+IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgXG4gICAgY29uc3QgbWVtYmVyOiBEeW5hbW9EQkNpcmNsZU1lbWJlciA9IHtcbiAgICAgIFBLOiBgQ0lSQ0xFIyR7Y2lyY2xlSWR9YCxcbiAgICAgIFNLOiBgTUVNQkVSIyR7dXNlcklkfWAsXG4gICAgICBHU0kzUEs6IGBNRU1CRVJfU1RBVFVTI2FjdGl2ZWAsXG4gICAgICBHU0kzU0s6IGBKT0lORUQjJHtub3d9YCxcbiAgICAgIGVudGl0eVR5cGU6ICdDSVJDTEVfTUVNQkVSJyxcbiAgICAgIHZlcnNpb246IDEsXG4gICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgIHVwZGF0ZWRBdDogbm93LFxuICAgICAgY2lyY2xlSWQsXG4gICAgICB1c2VySWQsXG4gICAgICByb2xlLFxuICAgICAgc3RhdHVzOiAnYWN0aXZlJyxcbiAgICAgIGpvaW5lZEF0OiBub3csXG4gICAgICBsYXN0QWN0aXZlOiBub3csXG4gICAgICBjb250cmlidXRpb25TY29yZTogMCxcbiAgICAgIGJhZGdlczogW10sXG4gICAgfTtcblxuICAgIC8vIEFsc28gY3JlYXRlIHJldmVyc2UgcmVsYXRpb25zaGlwIGZvciB1c2VyJ3MgY2lyY2xlc1xuICAgIGNvbnN0IHVzZXJDaXJjbGVSZWxhdGlvbjogRHluYW1vREJDaXJjbGVNZW1iZXIgPSB7XG4gICAgICAuLi5tZW1iZXIsXG4gICAgICBQSzogYFVTRVIjJHt1c2VySWR9YCxcbiAgICAgIFNLOiBgQ0lSQ0xFIyR7Y2lyY2xlSWR9YCxcbiAgICB9O1xuXG4gICAgLy8gVXNlIHRyYW5zYWN0aW9uIHRvIGVuc3VyZSBib3RoIHJlY29yZHMgYXJlIGNyZWF0ZWRcbiAgICBhd2FpdCB0aGlzLmR5bmFtb1NlcnZpY2UudHJhbnNhY3Rpb24oW1xuICAgICAge1xuICAgICAgICBvcGVyYXRpb246ICdwdXQnLFxuICAgICAgICBpdGVtOiBtZW1iZXIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBvcGVyYXRpb246ICdwdXQnLFxuICAgICAgICBpdGVtOiB1c2VyQ2lyY2xlUmVsYXRpb24sXG4gICAgICB9LFxuICAgIF0pO1xuXG4gICAgLy8gVXBkYXRlIGNpcmNsZSBtZW1iZXIgY291bnRcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVN0YXRzKGNpcmNsZUlkLCB7IG1lbWJlckNvdW50OiAxIH0pO1xuXG4gICAgcmV0dXJuIG1lbWJlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgbWVtYmVyIGZyb20gY2lyY2xlXG4gICAqL1xuICBhc3luYyByZW1vdmVNZW1iZXIoY2lyY2xlSWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBVc2UgdHJhbnNhY3Rpb24gdG8gcmVtb3ZlIGJvdGggcmVsYXRpb25zaGlwc1xuICAgIGF3YWl0IHRoaXMuZHluYW1vU2VydmljZS50cmFuc2FjdGlvbihbXG4gICAgICB7XG4gICAgICAgIG9wZXJhdGlvbjogJ2RlbGV0ZScsXG4gICAgICAgIGtleTogeyBQSzogYENJUkNMRSMke2NpcmNsZUlkfWAsIFNLOiBgTUVNQkVSIyR7dXNlcklkfWAgfSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG9wZXJhdGlvbjogJ2RlbGV0ZScsXG4gICAgICAgIGtleTogeyBQSzogYFVTRVIjJHt1c2VySWR9YCwgU0s6IGBDSVJDTEUjJHtjaXJjbGVJZH1gIH0sXG4gICAgICB9LFxuICAgIF0pO1xuXG4gICAgLy8gVXBkYXRlIGNpcmNsZSBtZW1iZXIgY291bnRcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVN0YXRzKGNpcmNsZUlkLCB7IG1lbWJlckNvdW50OiAtMSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgbWVtYmVyIHJvbGVcbiAgICovXG4gIGFzeW5jIHVwZGF0ZU1lbWJlclJvbGUoY2lyY2xlSWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcsIHJvbGU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICAgIC8vIFVwZGF0ZSBib3RoIHJlbGF0aW9uc2hpcCByZWNvcmRzXG4gICAgYXdhaXQgdGhpcy5keW5hbW9TZXJ2aWNlLnRyYW5zYWN0aW9uKFtcbiAgICAgIHtcbiAgICAgICAgb3BlcmF0aW9uOiAndXBkYXRlJyxcbiAgICAgICAga2V5OiB7IFBLOiBgQ0lSQ0xFIyR7Y2lyY2xlSWR9YCwgU0s6IGBNRU1CRVIjJHt1c2VySWR9YCB9LFxuICAgICAgICB1cGRhdGVFeHByZXNzaW9uOiAnU0VUICNyb2xlID0gOnJvbGUsICN1cGRhdGVkQXQgPSA6dXBkYXRlZEF0LCAjdmVyc2lvbiA9ICN2ZXJzaW9uICsgOmluYycsXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICcjcm9sZSc6ICdyb2xlJyxcbiAgICAgICAgICAnI3VwZGF0ZWRBdCc6ICd1cGRhdGVkQXQnLFxuICAgICAgICAgICcjdmVyc2lvbic6ICd2ZXJzaW9uJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICc6cm9sZSc6IHJvbGUsXG4gICAgICAgICAgJzp1cGRhdGVkQXQnOiBub3csXG4gICAgICAgICAgJzppbmMnOiAxLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgb3BlcmF0aW9uOiAndXBkYXRlJyxcbiAgICAgICAga2V5OiB7IFBLOiBgVVNFUiMke3VzZXJJZH1gLCBTSzogYENJUkNMRSMke2NpcmNsZUlkfWAgfSxcbiAgICAgICAgdXBkYXRlRXhwcmVzc2lvbjogJ1NFVCAjcm9sZSA9IDpyb2xlLCAjdXBkYXRlZEF0ID0gOnVwZGF0ZWRBdCwgI3ZlcnNpb24gPSAjdmVyc2lvbiArIDppbmMnLFxuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgICAnI3JvbGUnOiAncm9sZScsXG4gICAgICAgICAgJyN1cGRhdGVkQXQnOiAndXBkYXRlZEF0JyxcbiAgICAgICAgICAnI3ZlcnNpb24nOiAndmVyc2lvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOnJvbGUnOiByb2xlLFxuICAgICAgICAgICc6dXBkYXRlZEF0Jzogbm93LFxuICAgICAgICAgICc6aW5jJzogMSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFjdGl2ZSBjaXJjbGVzIHVzaW5nIEdTSTNcbiAgICovXG4gIGFzeW5jIGdldEFjdGl2ZUNpcmNsZXMob3B0aW9ucz86IFF1ZXJ5T3B0aW9ucyk6IFByb21pc2U8UXVlcnlSZXN1bHQ8RHluYW1vREJDaXJjbGU+PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucXVlcnlHU0koJ0dTSTMnLCAnQ0lSQ0xFX1NUQVRVUyNBQ1RJVkUnLCB1bmRlZmluZWQsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlYXJjaCBjaXJjbGVzIGJ5IGNyaXRlcmlhXG4gICAqL1xuICBhc3luYyBzZWFyY2hDaXJjbGVzKGNyaXRlcmlhOiB7XG4gICAgdHlwZT86IHN0cmluZztcbiAgICBjdWx0dXJhbEZvY3VzPzogc3RyaW5nW107XG4gICAgdGFncz86IHN0cmluZ1tdO1xuICAgIGlzUHJpdmF0ZT86IGJvb2xlYW47XG4gIH0sIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnMpOiBQcm9taXNlPFF1ZXJ5UmVzdWx0PER5bmFtb0RCQ2lyY2xlPj4ge1xuICAgIGxldCBiYXNlUXVlcnk6IFByb21pc2U8UXVlcnlSZXN1bHQ8RHluYW1vREJDaXJjbGU+PjtcbiAgICBcbiAgICAvLyBTdGFydCB3aXRoIHR5cGUtYmFzZWQgcXVlcnkgaWYgdHlwZSBpcyBzcGVjaWZpZWRcbiAgICBpZiAoY3JpdGVyaWEudHlwZSkge1xuICAgICAgYmFzZVF1ZXJ5ID0gdGhpcy5nZXRCeVR5cGUoY3JpdGVyaWEudHlwZSwgb3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIE90aGVyd2lzZSBnZXQgYWxsIGFjdGl2ZSBjaXJjbGVzXG4gICAgICBiYXNlUXVlcnkgPSB0aGlzLmdldEFjdGl2ZUNpcmNsZXMob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYmFzZVF1ZXJ5O1xuXG4gICAgLy8gQXBwbHkgYWRkaXRpb25hbCBmaWx0ZXJzIGluIG1lbW9yeSAoZm9yIGJldHRlciBwZXJmb3JtYW5jZSwgY29uc2lkZXIgdXNpbmcgc2VhcmNoIHNlcnZpY2UpXG4gICAgbGV0IGZpbHRlcmVkSXRlbXMgPSByZXN1bHQuaXRlbXM7XG5cbiAgICBpZiAoY3JpdGVyaWEuY3VsdHVyYWxGb2N1cyAmJiBjcml0ZXJpYS5jdWx0dXJhbEZvY3VzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZpbHRlcmVkSXRlbXMgPSBmaWx0ZXJlZEl0ZW1zLmZpbHRlcihjaXJjbGUgPT4gXG4gICAgICAgIGNpcmNsZS5zZXR0aW5ncy5jdWx0dXJhbEZvY3VzPy5zb21lKGZvY3VzID0+IFxuICAgICAgICAgIGNyaXRlcmlhLmN1bHR1cmFsRm9jdXMhLmluY2x1ZGVzKGZvY3VzKVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjcml0ZXJpYS50YWdzICYmIGNyaXRlcmlhLnRhZ3MubGVuZ3RoID4gMCkge1xuICAgICAgZmlsdGVyZWRJdGVtcyA9IGZpbHRlcmVkSXRlbXMuZmlsdGVyKGNpcmNsZSA9PlxuICAgICAgICBjaXJjbGUudGFncy5zb21lKHRhZyA9PiBjcml0ZXJpYS50YWdzIS5pbmNsdWRlcyh0YWcpKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY3JpdGVyaWEuaXNQcml2YXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGZpbHRlcmVkSXRlbXMgPSBmaWx0ZXJlZEl0ZW1zLmZpbHRlcihjaXJjbGUgPT5cbiAgICAgICAgY2lyY2xlLnNldHRpbmdzLmlzUHJpdmF0ZSA9PT0gY3JpdGVyaWEuaXNQcml2YXRlXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAuLi5yZXN1bHQsXG4gICAgICBpdGVtczogZmlsdGVyZWRJdGVtcyxcbiAgICAgIGNvdW50OiBmaWx0ZXJlZEl0ZW1zLmxlbmd0aCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBjaXJjbGUgc3RhdGlzdGljc1xuICAgKi9cbiAgYXN5bmMgdXBkYXRlU3RhdHMoY2lyY2xlSWQ6IHN0cmluZywgc3RhdHM6IFBhcnRpYWw8e1xuICAgIG1lbWJlckNvdW50OiBudW1iZXI7XG4gICAgYWN0aXZlTWVtYmVyczogbnVtYmVyO1xuICAgIHBvc3RzVGhpc1dlZWs6IG51bWJlcjtcbiAgICBwb3N0c1RoaXNNb250aDogbnVtYmVyO1xuICAgIGVuZ2FnZW1lbnRSYXRlOiBudW1iZXI7XG4gICAgYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyO1xuICB9Pik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHsgUEssIFNLIH0gPSBLZXlQYXR0ZXJucy5DSVJDTEVfTUVUQURBVEEoY2lyY2xlSWQpO1xuICAgIFxuICAgIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgICcjdXBkYXRlZEF0JzogJ3VwZGF0ZWRBdCcsXG4gICAgICAnI3ZlcnNpb24nOiAndmVyc2lvbicsXG4gICAgfTtcbiAgICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICAgJzp1cGRhdGVkQXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAnOnZlcnNpb25JbmNyZW1lbnQnOiAxLFxuICAgIH07XG5cbiAgICAvLyBCdWlsZCB1cGRhdGUgZXhwcmVzc2lvbnMgZm9yIGVhY2ggc3RhdFxuICAgIE9iamVjdC5lbnRyaWVzKHN0YXRzKS5mb3JFYWNoKChbc3RhdE5hbWUsIHZhbHVlXSkgPT4ge1xuICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29uc3QgYXR0ck5hbWUgPSBgI3N0YXRzXyR7c3RhdE5hbWV9YDtcbiAgICAgICAgY29uc3QgYXR0clZhbHVlID0gYDoke3N0YXROYW1lfWA7XG4gICAgICAgIFxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyAmJiAoc3RhdE5hbWUgPT09ICdtZW1iZXJDb3VudCcgfHwgc3RhdE5hbWUgPT09ICdwb3N0c1RoaXNXZWVrJyB8fCBzdGF0TmFtZSA9PT0gJ3Bvc3RzVGhpc01vbnRoJykpIHtcbiAgICAgICAgICAvLyBGb3IgY291bnRzLCB1c2UgQUREIG9wZXJhdGlvbiB0byBpbmNyZW1lbnQvZGVjcmVtZW50XG4gICAgICAgICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaChgI3N0YXRzLiR7YXR0ck5hbWV9ID0gaWZfbm90X2V4aXN0cygjc3RhdHMuJHthdHRyTmFtZX0sIDp6ZXJvKSArICR7YXR0clZhbHVlfWApO1xuICAgICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzp6ZXJvJ10gPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIEZvciByYXRlcyBhbmQgYXZlcmFnZXMsIHVzZSBTRVQgb3BlcmF0aW9uXG4gICAgICAgICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaChgI3N0YXRzLiR7YXR0ck5hbWV9ID0gJHthdHRyVmFsdWV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3N0YXRzJ10gPSAnc3RhdHMnO1xuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbYXR0ck5hbWVdID0gc3RhdE5hbWU7XG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbYXR0clZhbHVlXSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKHVwZGF0ZUV4cHJlc3Npb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIHVwZGF0ZUV4cHJlc3Npb25zLnB1c2goJyN1cGRhdGVkQXQgPSA6dXBkYXRlZEF0Jyk7XG4gICAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCcjdmVyc2lvbiA9ICN2ZXJzaW9uICsgOnZlcnNpb25JbmNyZW1lbnQnKTtcblxuICAgICAgYXdhaXQgdGhpcy5keW5hbW9TZXJ2aWNlLnVwZGF0ZUl0ZW0oUEssIFNLLCB7XG4gICAgICAgIHVwZGF0ZUV4cHJlc3Npb246IGBTRVQgJHt1cGRhdGVFeHByZXNzaW9ucy5qb2luKCcsICcpfWAsXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgY2lyY2xlIHdpdGggcHJvcGVyIGtleSBnZW5lcmF0aW9uXG4gICAqL1xuICBhc3luYyBjcmVhdGUoaXRlbTogT21pdDxEeW5hbW9EQkNpcmNsZSwgJ2NyZWF0ZWRBdCcgfCAndXBkYXRlZEF0JyB8ICd2ZXJzaW9uJz4pOiBQcm9taXNlPER5bmFtb0RCQ2lyY2xlPiB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIFxuICAgIC8vIEdlbmVyYXRlIGtleXMgdXNpbmcgcGF0dGVybnNcbiAgICBjb25zdCB7IFBLLCBTSyB9ID0gS2V5UGF0dGVybnMuQ0lSQ0xFX01FVEFEQVRBKGl0ZW0uY2lyY2xlSWQpO1xuICAgIFxuICAgIGNvbnN0IG5ld0NpcmNsZTogRHluYW1vREJDaXJjbGUgPSB7XG4gICAgICAuLi5pdGVtLFxuICAgICAgUEssXG4gICAgICBTSyxcbiAgICAgIEdTSTFQSzogYENJUkNMRV9UWVBFIyR7aXRlbS50eXBlfWAsXG4gICAgICBHU0kxU0s6IGBDUkVBVEVEIyR7bm93fWAsXG4gICAgICBHU0kzUEs6IGBDSVJDTEVfU1RBVFVTIyR7aXRlbS5zdGF0dXMgfHwgJ0FDVElWRSd9YCxcbiAgICAgIEdTSTNTSzogYFVQREFURUQjJHtub3d9YCxcbiAgICAgIEdTSTRQSzogYFRFTkFOVCMkeyhpdGVtIGFzIGFueSkudGVuYW50SWQgfHwgJ2RlZmF1bHQnfSNDSVJDTEVTYCxcbiAgICAgIEdTSTRTSzogYENSRUFURUQjJHtub3d9YCxcbiAgICAgIGVudGl0eVR5cGU6ICdDSVJDTEUnLFxuICAgICAgdmVyc2lvbjogMSxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgdXBkYXRlZEF0OiBub3csXG4gICAgICBzdGF0dXM6IGl0ZW0uc3RhdHVzIHx8ICdBQ1RJVkUnLFxuICAgIH07XG5cbiAgICAvLyBWYWxpZGF0ZSBiZWZvcmUgY3JlYXRpbmdcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUVudGl0eVNwZWNpZmljKG5ld0NpcmNsZSk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2lyY2xlIHZhbGlkYXRpb24gZmFpbGVkOiAke3ZhbGlkYXRpb24uZXJyb3JzLm1hcChlID0+IGUubWVzc2FnZSkuam9pbignLCAnKX1gKTtcbiAgICB9XG5cbiAgICBjb25zdCBjcmVhdGVkQ2lyY2xlID0gYXdhaXQgdGhpcy5keW5hbW9TZXJ2aWNlLnB1dEl0ZW0obmV3Q2lyY2xlKTtcblxuICAgIC8vIEFkZCBjcmVhdG9yIGFzIGZpcnN0IG1lbWJlciB3aXRoIGFkbWluIHJvbGVcbiAgICBhd2FpdCB0aGlzLmFkZE1lbWJlcihpdGVtLmNpcmNsZUlkLCBpdGVtLmNyZWF0ZWRCeSwgJ2FkbWluJyk7XG5cbiAgICByZXR1cm4gY3JlYXRlZENpcmNsZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2lyY2xlIGJ5IElEIChjb252ZW5pZW5jZSBtZXRob2QpXG4gICAqL1xuICBhc3luYyBnZXRDaXJjbGVCeUlkKGNpcmNsZUlkOiBzdHJpbmcpOiBQcm9taXNlPER5bmFtb0RCQ2lyY2xlIHwgbnVsbD4ge1xuICAgIGNvbnN0IHsgUEssIFNLIH0gPSBLZXlQYXR0ZXJucy5DSVJDTEVfTUVUQURBVEEoY2lyY2xlSWQpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEJ5SWQoUEssIFNLKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgY2lyY2xlIHNldHRpbmdzXG4gICAqL1xuICBhc3luYyB1cGRhdGVTZXR0aW5ncyhjaXJjbGVJZDogc3RyaW5nLCBzZXR0aW5nc1VwZGF0ZXM6IFBhcnRpYWw8RHluYW1vREJDaXJjbGVbJ3NldHRpbmdzJ10+KTogUHJvbWlzZTxEeW5hbW9EQkNpcmNsZT4ge1xuICAgIGNvbnN0IHsgUEssIFNLIH0gPSBLZXlQYXR0ZXJucy5DSVJDTEVfTUVUQURBVEEoY2lyY2xlSWQpO1xuICAgIFxuICAgIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgICcjdXBkYXRlZEF0JzogJ3VwZGF0ZWRBdCcsXG4gICAgICAnI3ZlcnNpb24nOiAndmVyc2lvbicsXG4gICAgfTtcbiAgICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICAgJzp1cGRhdGVkQXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAnOnZlcnNpb25JbmNyZW1lbnQnOiAxLFxuICAgIH07XG5cbiAgICAvLyBCdWlsZCB1cGRhdGUgZXhwcmVzc2lvbnMgZm9yIHNldHRpbmdzIGZpZWxkc1xuICAgIE9iamVjdC5lbnRyaWVzKHNldHRpbmdzVXBkYXRlcykuZm9yRWFjaCgoW2ZpZWxkLCB2YWx1ZV0pID0+IHtcbiAgICAgIGNvbnN0IGF0dHJOYW1lID0gYCNzZXR0aW5nc18ke2ZpZWxkfWA7XG4gICAgICBjb25zdCBhdHRyVmFsdWUgPSBgOnNldHRpbmdzXyR7ZmllbGR9YDtcbiAgICAgIFxuICAgICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaChgI3NldHRpbmdzLiR7YXR0ck5hbWV9ID0gJHthdHRyVmFsdWV9YCk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNzZXR0aW5ncyddID0gJ3NldHRpbmdzJztcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1thdHRyTmFtZV0gPSBmaWVsZDtcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbYXR0clZhbHVlXSA9IHZhbHVlO1xuICAgIH0pO1xuXG4gICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgnI3VwZGF0ZWRBdCA9IDp1cGRhdGVkQXQnKTtcbiAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCcjdmVyc2lvbiA9ICN2ZXJzaW9uICsgOnZlcnNpb25JbmNyZW1lbnQnKTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLmR5bmFtb1NlcnZpY2UudXBkYXRlSXRlbTxEeW5hbW9EQkNpcmNsZT4oUEssIFNLLCB7XG4gICAgICB1cGRhdGVFeHByZXNzaW9uOiBgU0VUICR7dXBkYXRlRXhwcmVzc2lvbnMuam9pbignLCAnKX1gLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIHJldHVyblZhbHVlczogJ0FMTF9ORVcnLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBtZW1iZXIgYnkgY2lyY2xlIGFuZCB1c2VyIElEXG4gICAqL1xuICBhc3luYyBnZXRNZW1iZXIoY2lyY2xlSWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPER5bmFtb0RCQ2lyY2xlTWVtYmVyIHwgbnVsbD4ge1xuICAgIGNvbnN0IHsgUEssIFNLIH0gPSBLZXlQYXR0ZXJucy5DSVJDTEVfTUVNQkVSKGNpcmNsZUlkLCB1c2VySWQpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmR5bmFtb1NlcnZpY2UuZ2V0SXRlbTxEeW5hbW9EQkNpcmNsZU1lbWJlcj4oUEssIFNLKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB1c2VyIGlzIG1lbWJlciBvZiBjaXJjbGVcbiAgICovXG4gIGFzeW5jIGlzTWVtYmVyKGNpcmNsZUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgbWVtYmVyID0gYXdhaXQgdGhpcy5nZXRNZW1iZXIoY2lyY2xlSWQsIHVzZXJJZCk7XG4gICAgcmV0dXJuIG1lbWJlciAhPT0gbnVsbCAmJiBtZW1iZXIuc3RhdHVzID09PSAnYWN0aXZlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2lyY2xlcyBieSBtZW1iZXIgc3RhdHVzIHVzaW5nIEdTSTNcbiAgICovXG4gIGFzeW5jIGdldENpcmNsZXNCeU1lbWJlclN0YXR1cyhzdGF0dXM6IHN0cmluZywgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucyk6IFByb21pc2U8UXVlcnlSZXN1bHQ8RHluYW1vREJDaXJjbGVNZW1iZXI+PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucXVlcnlHU0koJ0dTSTMnLCBgTUVNQkVSX1NUQVRVUyMke3N0YXR1c31gLCB1bmRlZmluZWQsIG9wdGlvbnMpO1xuICB9XG59Il19