"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TitanKCache = void 0;
const redis_1 = require("redis");
class TitanKCache {
    constructor(config) {
        this.stats = { hits: 0, misses: 0, sets: 0, errors: 0 };
        const url = config?.url || globalThis.process?.env?.REDIS_URL || 'redis://localhost:6379';
        this.ttlSeconds = config?.ttlSeconds ?? 300;
        this.namespace = (config?.namespace || 'titan') + ':kcache:';
        this.client = (0, redis_1.createClient)({ url });
        this.client.on('error', () => {
            this.stats.errors += 1;
        });
        this.useMemory = String(globalThis.process?.env?.KCACHE_INMEMORY || '').toLowerCase() === 'true';
        this.memoryStore = new Map();
    }
    async connect() {
        if (this.useMemory)
            return;
        try {
            if (!this.client.isOpen) {
                await this.client.connect();
            }
        }
        catch {
            // Fallback to in-memory
            this.useMemory = true;
        }
    }
    async disconnect() {
        if (this.useMemory)
            return;
        if (this.client.isOpen) {
            await this.client.quit();
        }
    }
    makeKey(keyParts) {
        return this.namespace + keyParts.map((p) => String(p)).join('|');
    }
    async get(keyParts) {
        const key = this.makeKey(keyParts);
        if (this.useMemory) {
            const entry = this.memoryStore.get(key);
            if (!entry || entry.expiresAt < Date.now()) {
                this.memoryStore.delete(key);
                this.stats.misses += 1;
                return null;
            }
            this.stats.hits += 1;
            return entry.value;
        }
        else {
            try {
                const value = await this.client.get(key);
                if (value === null) {
                    this.stats.misses += 1;
                    return null;
                }
                this.stats.hits += 1;
                return JSON.parse(value);
            }
            catch {
                this.stats.errors += 1;
                return null;
            }
        }
    }
    async set(keyParts, value, ttlSeconds) {
        const key = this.makeKey(keyParts);
        if (this.useMemory) {
            const expiresAt = Date.now() + 1000 * (ttlSeconds ?? this.ttlSeconds);
            this.memoryStore.set(key, { value, expiresAt });
            this.stats.sets += 1;
        }
        else {
            try {
                await this.client.set(key, JSON.stringify(value), {
                    EX: ttlSeconds ?? this.ttlSeconds,
                });
                this.stats.sets += 1;
            }
            catch {
                this.stats.errors += 1;
            }
        }
    }
    async withCache(keyParts, producer, ttlSeconds) {
        const cached = await this.get(keyParts);
        if (cached !== null) {
            return { data: cached, cached: true };
        }
        const data = await producer();
        await this.set(keyParts, data, ttlSeconds);
        return { data, cached: false };
    }
    getStats() {
        return { ...this.stats };
    }
}
exports.TitanKCache = TitanKCache;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2NhY2hlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL3NlcnZpY2Uva2NhY2hlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFzRDtBQWV0RCxNQUFhLFdBQVc7SUFRdEIsWUFBWSxNQUFxQjtRQUp6QixVQUFLLEdBQWUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFLckUsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFFLEdBQUcsSUFBSyxVQUFrQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxJQUFJLHdCQUF3QixDQUFDO1FBQ25HLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxFQUFFLFVBQVUsSUFBSSxHQUFHLENBQUM7UUFDNUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLE1BQU0sRUFBRSxTQUFTLElBQUksT0FBTyxDQUFDLEdBQUcsVUFBVSxDQUFDO1FBQzdELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBQSxvQkFBWSxFQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1lBQzNCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFFLFVBQWtCLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxlQUFlLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxDQUFDO1FBQzFHLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxJQUFJLElBQUks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ZGlzQ2xpZW50VHlwZSB9IGZyb20gJ3JlZGlzJztcblxuZXhwb3J0IGludGVyZmFjZSBLQ2FjaGVDb25maWcge1xuICB1cmw/OiBzdHJpbmc7XG4gIHR0bFNlY29uZHM/OiBudW1iZXI7XG4gIG5hbWVzcGFjZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYWNoZVN0YXRzIHtcbiAgaGl0czogbnVtYmVyO1xuICBtaXNzZXM6IG51bWJlcjtcbiAgc2V0czogbnVtYmVyO1xuICBlcnJvcnM6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFRpdGFuS0NhY2hlPFQgPSB1bmtub3duPiB7XG4gIHByaXZhdGUgY2xpZW50OiBSZWRpc0NsaWVudFR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgdHRsU2Vjb25kczogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IG5hbWVzcGFjZTogc3RyaW5nO1xuICBwcml2YXRlIHN0YXRzOiBDYWNoZVN0YXRzID0geyBoaXRzOiAwLCBtaXNzZXM6IDAsIHNldHM6IDAsIGVycm9yczogMCB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHVzZU1lbW9yeTogYm9vbGVhbjtcbiAgcHJpdmF0ZSBtZW1vcnlTdG9yZTogTWFwPHN0cmluZywgeyB2YWx1ZTogVDsgZXhwaXJlc0F0OiBudW1iZXIgfT47IFxuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZz86IEtDYWNoZUNvbmZpZykge1xuICAgIGNvbnN0IHVybCA9IGNvbmZpZz8udXJsIHx8IChnbG9iYWxUaGlzIGFzIGFueSkucHJvY2Vzcz8uZW52Py5SRURJU19VUkwgfHwgJ3JlZGlzOi8vbG9jYWxob3N0OjYzNzknO1xuICAgIHRoaXMudHRsU2Vjb25kcyA9IGNvbmZpZz8udHRsU2Vjb25kcyA/PyAzMDA7XG4gICAgdGhpcy5uYW1lc3BhY2UgPSAoY29uZmlnPy5uYW1lc3BhY2UgfHwgJ3RpdGFuJykgKyAnOmtjYWNoZTonO1xuICAgIHRoaXMuY2xpZW50ID0gY3JlYXRlQ2xpZW50KHsgdXJsIH0pO1xuICAgIHRoaXMuY2xpZW50Lm9uKCdlcnJvcicsICgpID0+IHtcbiAgICAgIHRoaXMuc3RhdHMuZXJyb3JzICs9IDE7XG4gICAgfSk7XG4gICAgdGhpcy51c2VNZW1vcnkgPSBTdHJpbmcoKGdsb2JhbFRoaXMgYXMgYW55KS5wcm9jZXNzPy5lbnY/LktDQUNIRV9JTk1FTU9SWSB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnO1xuICAgIHRoaXMubWVtb3J5U3RvcmUgPSBuZXcgTWFwKCk7XG4gIH1cblxuICBhc3luYyBjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLnVzZU1lbW9yeSkgcmV0dXJuO1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMuY2xpZW50LmlzT3Blbikge1xuICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5jb25uZWN0KCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBGYWxsYmFjayB0byBpbi1tZW1vcnlcbiAgICAgICh0aGlzIGFzIGFueSkudXNlTWVtb3J5ID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkaXNjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLnVzZU1lbW9yeSkgcmV0dXJuO1xuICAgIGlmICh0aGlzLmNsaWVudC5pc09wZW4pIHtcbiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnF1aXQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1ha2VLZXkoa2V5UGFydHM6IEFycmF5PHN0cmluZyB8IG51bWJlcj4pOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm5hbWVzcGFjZSArIGtleVBhcnRzLm1hcCgocCkgPT4gU3RyaW5nKHApKS5qb2luKCd8Jyk7XG4gIH1cblxuICBhc3luYyBnZXQoa2V5UGFydHM6IEFycmF5PHN0cmluZyB8IG51bWJlcj4pOiBQcm9taXNlPFQgfCBudWxsPiB7XG4gICAgY29uc3Qga2V5ID0gdGhpcy5tYWtlS2V5KGtleVBhcnRzKTtcbiAgICBpZiAodGhpcy51c2VNZW1vcnkpIHtcbiAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5tZW1vcnlTdG9yZS5nZXQoa2V5KTtcbiAgICAgIGlmICghZW50cnkgfHwgZW50cnkuZXhwaXJlc0F0IDwgRGF0ZS5ub3coKSkge1xuICAgICAgICB0aGlzLm1lbW9yeVN0b3JlLmRlbGV0ZShrZXkpO1xuICAgICAgICB0aGlzLnN0YXRzLm1pc3NlcyArPSAxO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3RhdHMuaGl0cyArPSAxO1xuICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuY2xpZW50LmdldChrZXkpO1xuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcbiAgICAgICAgICB0aGlzLnN0YXRzLm1pc3NlcyArPSAxO1xuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RhdHMuaGl0cyArPSAxO1xuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSkgYXMgVDtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICB0aGlzLnN0YXRzLmVycm9ycyArPSAxO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXQoa2V5UGFydHM6IEFycmF5PHN0cmluZyB8IG51bWJlcj4sIHZhbHVlOiBULCB0dGxTZWNvbmRzPzogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qga2V5ID0gdGhpcy5tYWtlS2V5KGtleVBhcnRzKTtcbiAgICBpZiAodGhpcy51c2VNZW1vcnkpIHtcbiAgICAgIGNvbnN0IGV4cGlyZXNBdCA9IERhdGUubm93KCkgKyAxMDAwICogKHR0bFNlY29uZHMgPz8gdGhpcy50dGxTZWNvbmRzKTtcbiAgICAgIHRoaXMubWVtb3J5U3RvcmUuc2V0KGtleSwgeyB2YWx1ZSwgZXhwaXJlc0F0IH0pO1xuICAgICAgdGhpcy5zdGF0cy5zZXRzICs9IDE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNldChrZXksIEpTT04uc3RyaW5naWZ5KHZhbHVlKSwge1xuICAgICAgICAgIEVYOiB0dGxTZWNvbmRzID8/IHRoaXMudHRsU2Vjb25kcyxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc3RhdHMuc2V0cyArPSAxO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRoaXMuc3RhdHMuZXJyb3JzICs9IDE7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgd2l0aENhY2hlKFxuICAgIGtleVBhcnRzOiBBcnJheTxzdHJpbmcgfCBudW1iZXI+LFxuICAgIHByb2R1Y2VyOiAoKSA9PiBQcm9taXNlPFQ+LFxuICAgIHR0bFNlY29uZHM/OiBudW1iZXIsXG4gICk6IFByb21pc2U8eyBkYXRhOiBUOyBjYWNoZWQ6IGJvb2xlYW4gfSA+IHtcbiAgICBjb25zdCBjYWNoZWQgPSBhd2FpdCB0aGlzLmdldChrZXlQYXJ0cyk7XG4gICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHsgZGF0YTogY2FjaGVkLCBjYWNoZWQ6IHRydWUgfTtcbiAgICB9XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHByb2R1Y2VyKCk7XG4gICAgYXdhaXQgdGhpcy5zZXQoa2V5UGFydHMsIGRhdGEsIHR0bFNlY29uZHMpO1xuICAgIHJldHVybiB7IGRhdGEsIGNhY2hlZDogZmFsc2UgfTtcbiAgfVxuXG4gIGdldFN0YXRzKCk6IENhY2hlU3RhdHMge1xuICAgIHJldHVybiB7IC4uLnRoaXMuc3RhdHMgfTtcbiAgfVxufVxuXG4iXX0=